<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Truth スケジュール管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
    <style>
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-10px,0); }
            70% { transform: translate3d(0,-5px,0); }
            90% { transform: translate3d(0,-2px,0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        .hidden { display: none; }
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
        .bg-white\/90 { background-color: rgba(255, 255, 255, 0.9); }
        .bg-white\/80 { background-color: rgba(255, 255, 255, 0.8); }
        .bg-white\/70 { background-color: rgba(255, 255, 255, 0.7); }
        .bg-white\/60 { background-color: rgba(255, 255, 255, 0.6); }
        .bg-white\/50 { background-color: rgba(255, 255, 255, 0.5); }
        .bg-black\/50 { background-color: rgba(0, 0, 0, 0.5); }
        
        /* サイボウズ表示の修正 */
        .cybozu-grid {
            display: grid;
            width: 100%;
            overflow-x: auto;
        }
        
        .cybozu-header {
            display: grid;
            grid-template-columns: 200px repeat(7, minmax(120px, 1fr));
            border-bottom: 2px solid #a855f7;
            background: linear-gradient(to right, #f3e8ff, #fce7f3);
            min-width: 1040px;
        }
        
        .cybozu-dept-header {
            display: grid;
            grid-template-columns: 200px repeat(7, minmax(120px, 1fr));
            border-bottom: 1px solid #a855f7;
            background: linear-gradient(to right, #f3e8ff, #fce7f3);
            min-width: 1040px;
        }
        
        .cybozu-row {
            display: grid;
            grid-template-columns: 200px repeat(7, minmax(120px, 1fr));
            border-bottom: 1px solid #e9d5ff;
            min-width: 1040px;
        }
        
        .cybozu-cell {
            border-right: 1px solid #e9d5ff;
            min-height: 80px;
            padding: 8px;
        }
        
        .cybozu-name-cell {
            background-color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            padding: 12px;
        }

        /* 同期状態表示 */
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            opacity: 0.9;
            transition: all 0.3s ease;
        }
        
        .sync-success { background: linear-gradient(45deg, #10b981, #059669); }
        .sync-error { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .sync-pending { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .sync-offline { background: linear-gradient(45deg, #6b7280, #4b5563); }
        
        /* モバイル対応 */
        @media (max-width: 768px) {
            .calendar-grid {
                font-size: 0.75rem;
            }
            .calendar-cell {
                min-height: 4rem !important;
                padding: 0.25rem !important;
            }
            .schedule-item {
                font-size: 0.6rem !important;
                padding: 0.125rem 0.25rem !important;
                margin-bottom: 0.125rem !important;
            }
            .mobile-header {
                padding: 0.75rem !important;
            }
            .mobile-controls {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            .mobile-button {
                font-size: 0.75rem !important;
                padding: 0.5rem 0.75rem !important;
            }
            .mobile-modal {
                margin: 0.5rem !important;
            }
            
            /* モバイル版サイボウズ表示 */
            .cybozu-grid {
                display: block;
            }
            
            .cybozu-header,
            .cybozu-dept-header,
            .cybozu-row {
                display: block;
                min-width: auto;
            }
            
            .sync-status {
                top: 10px;
                right: 10px;
                font-size: 10px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- 同期状態表示 -->
    <div id="syncStatus" class="sync-status hidden">
        <span id="syncStatusText">オフライン</span>
    </div>

    <!-- ログイン画面 -->
    <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-pink-100 via-purple-50 to-indigo-100 flex items-center justify-center p-4">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-10 left-10 text-4xl animate-bounce">✨</div>
            <div class="absolute top-20 right-20 text-3xl animate-pulse">🌟</div>
            <div class="absolute bottom-20 left-20 text-4xl animate-bounce">💫</div>
            <div class="absolute bottom-10 right-10 text-2xl animate-pulse">⭐</div>
        </div>
        
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl w-full max-w-md p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400"></div>
            
            <div class="text-center mb-6">
                <div class="text-4xl mb-3 animate-pulse">🎯</div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-1">
                    The truth
                </h1>
                <p class="text-gray-600 font-medium">株式会社大真工業</p>
                <p class="text-sm text-gray-500 flex items-center justify-center space-x-1">
                    <span>✨</span>
                    <span>スケジュール管理システム</span>
                    <span>✨</span>
                </p>
                
                <!-- Dropbox連携状態表示 -->
                <div id="dropboxStatus" class="mt-3 p-2 rounded-lg bg-blue-50 border border-blue-200">
                    <div class="flex items-center justify-center space-x-2 text-sm">
                        <span id="dropboxIcon">☁️</span>
                        <span id="dropboxStatusText" class="text-blue-700 font-medium">Dropbox未接続</span>
                    </div>
                    <button id="dropboxConnectBtn" onclick="connectToDropbox()" 
                            class="mt-2 w-full px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-bold">
                        📁 Dropboxに接続
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <!-- 部署選択 -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center space-x-2">
                        <span>🏢</span>
                        <span>部署を選択してください</span>
                    </label>
                    <div class="space-y-2">
                        <button onclick="selectDepartment('管理部')" id="dept-管理部" 
                                class="w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xl">🏢</span>
                                    <span class="font-bold">管理部</span>
                                </div>
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-bold">4名</span>
                            </div>
                        </button>
                        <button onclick="selectDepartment('工事部')" id="dept-工事部"
                                class="w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xl">🏗️</span>
                                    <span class="font-bold">工事部</span>
                                </div>
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-bold">9名</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- 社員選択 -->
                <div id="employeeSection" class="hidden animate-fadeIn">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center space-x-2">
                        <span>👤</span>
                        <span>社員を選択してください</span>
                    </label>
                    <div id="employeeList" class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto p-2 bg-gray-50/50 rounded-xl">
                    </div>
                </div>

                <!-- パスワード入力 -->
                <div id="passwordSection" class="hidden animate-fadeIn">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center space-x-2">
                        <span>🔑</span>
                        <span>パスワードを入力してください</span>
                    </label>
                    <div class="relative">
                        <input type="password" id="passwordInput"
                               class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                               placeholder="パスワードを入力してね 🔐"
                               onkeypress="if(event.key==='Enter') handleLogin()">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xl">🔐</div>
                    </div>
                </div>
            </div>

            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm"></div>

            <button onclick="handleLogin()" id="loginBtn"
                    class="w-full mt-4 bg-gradient-to-r from-gray-300 to-gray-400 text-white py-3 rounded-xl font-bold cursor-not-allowed transition-all duration-300 flex items-center justify-center space-x-2"
                    disabled>
                <span>🚀</span>
                <span>ログイン</span>
                <span>✨</span>
            </button>
            
            <button onclick="showFileSharing()"
                    class="w-full mt-3 bg-gradient-to-r from-green-500 to-teal-500 text-white py-3 rounded-xl hover:from-green-600 hover:to-teal-600 transition-all duration-300 font-bold transform hover:scale-105 shadow-lg flex items-center justify-center space-x-2">
                <span>📁</span>
                <span>物件ファイル共有</span>
                <span>📋</span>
            </button>
            
            <!-- データ管理メニュー -->
            <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <div class="text-center text-sm text-gray-600 font-bold">📊 データ管理</div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportData()" 
                            class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-bold flex items-center justify-center space-x-2">
                        <span>📤</span>
                        <span>エクスポート</span>
                    </button>
                    <button onclick="importData()" 
                            class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-bold flex items-center justify-center space-x-2">
                        <span>📥</span>
                        <span>インポート</span>
                    </button>
                </div>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
            </div>
        </div>
    </div>

    <!-- メイン画面 -->
    <div id="mainScreen" class="hidden min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
        <!-- ヘッダー -->
        <header class="bg-gradient-to-r from-purple-600 via-pink-500 to-indigo-600 text-white mobile-header shadow-xl">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="text-xl md:text-2xl animate-pulse">🎯</div>
                    <div>
                        <h1 class="text-sm md:text-xl font-bold flex items-center space-x-1 md:space-x-2">
                            <span>The truth</span>
                            <span class="animate-spin text-xs md:text-sm">✨</span>
                        </h1>
                        <p class="text-purple-100 text-xs md:text-sm hidden md:block">株式会社大真工業 ✨ スケジュール管理システム</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="text-right bg-white/20 rounded-xl p-1 md:p-2 backdrop-blur-sm">
                        <p id="currentUserName" class="font-bold text-xs md:text-sm flex items-center space-x-1"></p>
                        <p id="currentUserDept" class="text-xs text-purple-100 hidden md:block"></p>
                    </div>
                    <button onclick="showAddModal()"
                            class="mobile-button bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500 px-2 md:px-4 py-1 md:py-2 rounded-xl flex items-center space-x-1 md:space-x-2 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold">
                        <span>➕</span>
                        <span class="hidden md:inline">予定追加</span>
                    </button>
                    <button onclick="syncData()"
                            class="mobile-button bg-gradient-to-r from-blue-400 to-cyan-400 hover:from-blue-500 hover:to-cyan-500 p-1 md:p-2 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg"
                            title="データ同期">
                        <span>🔄</span>
                    </button>
                    <button onclick="handleLogout()"
                            class="mobile-button bg-gradient-to-r from-red-400 to-pink-400 hover:from-red-500 hover:to-pink-500 p-1 md:p-2 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg"
                            title="ログアウト">
                        <span>🚪</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-6xl mx-auto p-4">
            <!-- 表示モード切替・コントロール -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-lg p-3 md:p-4 mb-4 border border-purple-100">
                <div class="mobile-controls flex flex-wrap items-center justify-between gap-3">
                    <!-- 表示モード切替 -->
                    <div class="flex rounded-xl overflow-hidden shadow-sm w-full md:w-auto">
                        <button onclick="setViewMode('calendar')" id="calendarModeBtn"
                                class="mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold transition-all duration-300 transform hover:scale-105">
                            <span class="md:hidden">📅</span>
                            <span class="hidden md:inline">📅 カレンダー表示</span>
                        </button>
                        <button onclick="setViewMode('cybozu')" id="cybozuModeBtn"
                                class="mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-purple-100 hover:to-pink-100 font-bold transition-all duration-300 transform hover:scale-105">
                            <span class="md:hidden">👥</span>
                            <span class="hidden md:inline">👥 社員別表示</span>
                        </button>
                    </div>
                    
                    <!-- カレンダーコントロール -->
                    <div id="calendarControls" class="flex flex-col md:flex-row items-stretch md:items-center space-y-2 md:space-y-0 md:space-x-3 w-full md:w-auto">
                        <div class="flex items-center space-x-2 bg-white/50 rounded-xl p-2">
                            <span class="text-xs md:text-sm">👤</span>
                            <select id="userFilter" onchange="filterByUser()" 
                                    class="border border-purple-200 rounded-lg px-2 py-1 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 bg-white/80 text-xs md:text-sm min-w-0 flex-1">
                                <option value="all">🌟 全員</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center justify-center space-x-2 bg-white/50 rounded-xl p-2">
                            <button onclick="previousMonth()"
                                    class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white rounded-lg hover:from-purple-500 hover:to-pink-500 transition-all duration-300 transform hover:scale-105 font-bold">
                                ◀
                            </button>
                            <span id="currentMonth" class="text-xs md:text-sm font-bold text-purple-700 min-w-20 md:min-w-24 text-center"></span>
                            <button onclick="nextMonth()"
                                    class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white rounded-lg hover:from-purple-500 hover:to-pink-500 transition-all duration-300 transform hover:scale-105 font-bold">
                                ▶
                            </button>
                        </div>
                    </div>

                    <!-- サイボウズコントロール -->
                    <div id="cybozuControls" class="hidden flex items-center justify-center space-x-2 bg-white/50 rounded-xl p-2 w-full md:w-auto">
                        <button onclick="previousWeek()"
                                class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-pink-400 to-purple-400 text-white rounded-lg hover:from-pink-500 hover:to-purple-500 transition-all duration-300 transform hover:scale-105 font-bold">
                            ◀
                        </button>
                        <span id="currentWeek" class="text-xs md:text-sm font-bold text-purple-700 text-center flex-1"></span>
                        <button onclick="nextWeek()"
                                class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-pink-400 to-purple-400 text-white rounded-lg hover:from-pink-500 hover:to-purple-500 transition-all duration-300 transform hover:scale-105 font-bold">
                            ▶
                        </button>
                    </div>
                </div>
            </div>

            <!-- カレンダー表示 -->
            <div id="calendarView" class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden border border-purple-100">
                <div class="grid grid-cols-7 bg-gradient-to-r from-purple-100 to-pink-100 border-b border-purple-200">
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-red-500">🌅<span class="hidden md:inline"> 日</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">🌙<span class="hidden md:inline"> 月</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">🔥<span class="hidden md:inline"> 火</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">💧<span class="hidden md:inline"> 水</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">🌳<span class="hidden md:inline"> 木</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">⭐<span class="hidden md:inline"> 金</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-blue-500">🌈<span class="hidden md:inline"> 土</span></div>
                </div>
                <div id="calendarGrid" class="calendar-grid grid grid-cols-7">
                </div>
            </div>

            <!-- サイボウズ風表示 -->
            <div id="cybozuView" class="hidden bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg overflow-x-auto border border-purple-100">
                <div id="cybozuGrid" class="cybozu-grid">
                </div>
            </div>
        </div>
    </div>

    <!-- スケジュール追加モーダル -->
    <div id="addModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-2 md:p-4">
        <div class="mobile-modal bg-white/95 backdrop-blur-sm rounded-2xl w-full max-w-lg max-h-screen overflow-y-auto shadow-2xl border border-purple-200">
            <div class="p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg md:text-xl font-bold text-purple-700 flex items-center space-x-2">
                        <span>🎉</span>
                        <span>新しい予定</span>
                        <span>✨</span>
                    </h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-purple-600 transition-colors">
                        <span class="text-2xl">×</span>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>🎯</span>
                            <span>タイトル</span>
                        </label>
                        <input type="text" id="eventTitle"
                               class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                               placeholder="楽しい予定のタイトルを入力してね 🌟">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>👥</span>
                            <span>対象者（複数選択可）</span>
                        </label>
                        <div id="employeeCheckboxes" class="border-2 border-purple-200 rounded-xl p-3 max-h-32 overflow-y-auto bg-purple-50/50">
                        </div>
                        <div id="selectedEmployees" class="hidden mt-2 p-2 bg-purple-100 rounded-xl">
                            <div class="text-sm text-purple-700 font-bold">
                                ✨ 選択中: <span id="selectedEmployeesList"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📝</span>
                            <span>種類</span>
                        </label>
                        <select id="eventType"
                                class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 bg-white/80 font-bold">
                            <option value="site">🏗️ 現場</option>
                            <option value="meeting">💬 打合せ</option>
                            <option value="leave">🌴 休暇</option>
                            <option value="training">📚 研修</option>
                            <option value="other">✨ その他</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕐</span>
                                <span>開始時間</span>
                            </label>
                            <input type="datetime-local" id="eventStartTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕑</span>
                                <span>終了時間</span>
                            </label>
                            <input type="datetime-local" id="eventEndTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📋</span>
                            <span>詳細</span>
                        </label>
                        <textarea id="eventDescription"
                                  class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                                  rows="3" placeholder="予定の詳細を入力してね ✨"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-purple-200">
                    <button onclick="closeModal()"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 bg-gray-200 hover:bg-gray-300 rounded-xl transition-all duration-300 font-bold">
                        キャンセル
                    </button>
                    <button onclick="addSchedule()"
                            class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold flex items-center space-x-2">
                        <span>🎉</span>
                        <span>追加</span>
                        <span>✨</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- スケジュール編集モーダル -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-2 md:p-4">
        <div class="mobile-modal bg-white/95 backdrop-blur-sm rounded-2xl w-full max-w-lg max-h-screen overflow-y-auto shadow-2xl border border-purple-200">
            <div class="p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg md:text-xl font-bold text-purple-700 flex items-center space-x-2">
                        <span>✏️</span>
                        <span>予定の編集</span>
                        <span>✨</span>
                    </h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-purple-600 transition-colors">
                        <span class="text-2xl">×</span>
                    </button>
                </div>
                
                <!-- 履歴情報 -->
                <div id="eventHistory" class="mb-4 p-3 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl border border-purple-200 text-sm text-purple-700">
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>🎯</span>
                            <span>タイトル</span>
                        </label>
                        <input type="text" id="editEventTitle"
                               class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>👥</span>
                            <span>対象者（複数選択可）</span>
                        </label>
                        <div id="editEmployeeCheckboxes" class="border-2 border-purple-200 rounded-xl p-3 max-h-32 overflow-y-auto bg-purple-50/50">
                        </div>
                        <div id="editSelectedEmployees" class="hidden mt-2 p-2 bg-purple-100 rounded-xl">
                            <div class="text-sm text-purple-700 font-bold">
                                ✨ 選択中: <span id="editSelectedEmployeesList"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📝</span>
                            <span>種類</span>
                        </label>
                        <select id="editEventType"
                                class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 bg-white/80 font-bold">
                            <option value="site">🏗️ 現場</option>
                            <option value="meeting">💬 打合せ</option>
                            <option value="leave">🌴 休暇</option>
                            <option value="training">📚 研修</option>
                            <option value="other">✨ その他</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕐</span>
                                <span>開始時間</span>
                            </label>
                            <input type="datetime-local" id="editEventStartTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕑</span>
                                <span>終了時間</span>
                            </label>
                            <input type="datetime-local" id="editEventEndTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📋</span>
                            <span>詳細</span>
                        </label>
                        <textarea id="editEventDescription"
                                  class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                                  rows="3"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-between mt-6 pt-4 border-t border-purple-200">
                    <button onclick="deleteSchedule()"
                            class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-xl hover:from-red-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold flex items-center space-x-2">
                        <span>🗑️</span>
                        <span>削除</span>
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="closeModal()"
                                class="px-4 py-2 text-gray-600 hover:text-gray-800 bg-gray-200 hover:bg-gray-300 rounded-xl transition-all duration-300 font-bold">
                            キャンセル
                        </button>
                        <button onclick="updateSchedule()"
                                class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold flex items-center space-x-2">
                            <span>💾</span>
                            <span>更新</span>
                            <span>✨</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Dropbox設定 ===
        const DROPBOX_APP_KEY = 'YOUR_DROPBOX_APP_KEY'; // 実際のアプリケーションキーに置き換える
        let dropboxAuth = null;
        let isDropboxConnected = false;

        // === データ定義 ===
        const departments = {
            '管理部': [
                { id: 1, name: '大仁田　真', password: '1', emoji: '👨‍💼', color: '#ff6b6b' },
                { id: 2, name: '高橋　伸輔', password: '3', emoji: '🧑‍💻', color: '#4ecdc4' },
                { id: 3, name: '佐々木　翔太', password: '4', emoji: '👨‍🔬', color: '#45b7d1' },
                { id: 4, name: '町田　総士', password: '5', emoji: '👨‍🎯', color: '#f9ca24' }
            ],
            '工事部': [
                { id: 5, name: '大仁田　実', password: '2', emoji: '👷‍♂️', color: '#f0932b' },
                { id: 6, name: '長谷　章一', password: '6', emoji: '🔧', color: '#eb4d4b' },
                { id: 7, name: '篠田　将吏', password: '7', emoji: '⚡', color: '#6c5ce7' },
                { id: 8, name: '荒木　晃太', password: '8', emoji: '🛠️', color: '#fd79a8' },
                { id: 9, name: '仲田　淳次', password: '9', emoji: '🏗️', color: '#00b894' },
                { id: 10, name: '白谷　富敬', password: '10', emoji: '⚙️', color: '#e17055' },
                { id: 11, name: '木村　善幸', password: '11', emoji: '🔨', color: '#81ecec' },
                { id: 12, name: '小林　常利', password: '12', emoji: '🚧', color: '#74b9ff' },
                { id: 13, name: '氏森　ルイス', password: '13', emoji: '🌟', color: '#55a3ff' }
            ]
        };

        // 全社員リスト
        const allEmployees = [];
        Object.entries(departments).forEach(([dept, employees]) => {
            employees.forEach(emp => {
                allEmployees.push({
                    ...emp,
                    department: dept
                });
            });
        });

        // === データ管理（LocalStorage + Dropbox対応） ===
        const DEFAULT_DATA = {
            currentUser: null,
            selectedDepartment: '',
            selectedEmployee: '',
            viewMode: 'calendar',
            currentDate: new Date(),
            selectedUserFilter: 'all',
            editingEventId: null,
            schedules: [
                {
                    id: 1,
                    title: '🎯 管理部会議',
                    description: '月次売上報告 📊',
                    startTime: '2025-06-11T09:00',
                    endTime: '2025-06-11T10:00',
                    employeeIds: [1, 2, 3, 4],
                    createdBy: 1,
                    createdAt: '2025-06-10T08:00:00',
                    lastEditedBy: 1,
                    lastEditedAt: '2025-06-10T08:00:00',
                    type: 'meeting',
                    isPublic: true
                },
                {
                    id: 2,
                    title: '🏗️ 現場視察',
                    description: 'A工事現場の進捗確認 ✨',
                    startTime: '2025-06-11T14:00',
                    endTime: '2025-06-11T17:00',
                    employeeIds: [5, 6],
                    createdBy: 5,
                    createdAt: '2025-06-10T10:00:00',
                    lastEditedBy: 5,
                    lastEditedAt: '2025-06-10T10:00:00',
                    type: 'site',
                    isPublic: true
                },
                {
                    id: 3,
                    title: '📚 安全講習',
                    description: '新入社員向け安全教育 🛡️',
                    startTime: '2025-06-12T10:00',
                    endTime: '2025-06-12T12:00',
                    employeeIds: [7, 8, 9],
                    createdBy: 6,
                    createdAt: '2025-06-09T15:00:00',
                    lastEditedBy: 6,
                    lastEditedAt: '2025-06-09T15:00:00',
                    type: 'training',
                    isPublic: true
                }
            ],
            projects: [],
            projectFiles: {},
            currentProjectId: null,
            lastSyncTime: null,
            version: '1.0.0'
        };

        let appData = { ...DEFAULT_DATA };

        // データアクセサー
        let currentUser = appData.currentUser;
        let selectedDepartment = appData.selectedDepartment;
        let selectedEmployee = appData.selectedEmployee;
        let viewMode = appData.viewMode;
        let currentDate = appData.currentDate;
        let selectedUserFilter = appData.selectedUserFilter;
        let editingEventId = appData.editingEventId;
        let schedules = appData.schedules;
        let projects = appData.projects;
        let projectFiles = appData.projectFiles;
        let currentProjectId = appData.currentProjectId;

        // === データ永続化機能 ===
        function saveToLocalStorage() {
            try {
                syncToAppData();
                localStorage.setItem('scheduleAppData', JSON.stringify({
                    ...appData,
                    lastSaveTime: new Date().toISOString()
                }));
                updateSyncStatus('success', 'ローカル保存完了');
                return true;
            } catch (error) {
                console.error('LocalStorage保存エラー:', error);
                updateSyncStatus('error', 'ローカル保存失敗');
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('scheduleAppData');
                if (saved) {
                    const data = JSON.parse(saved);
                    appData = { ...DEFAULT_DATA, ...data };
                    // 日付オブジェクトを復元
                    if (data.currentDate) {
                        appData.currentDate = new Date(data.currentDate);
                    }
                    syncFromAppData();
                    updateSyncStatus('success', 'ローカルデータ読み込み完了');
                    return true;
                }
            } catch (error) {
                console.error('LocalStorage読み込みエラー:', error);
                updateSyncStatus('error', 'ローカルデータ読み込み失敗');
            }
            return false;
        }

        function syncToAppData() {
            appData.currentUser = currentUser;
            appData.selectedDepartment = selectedDepartment;
            appData.selectedEmployee = selectedEmployee;
            appData.viewMode = viewMode;
            appData.currentDate = currentDate;
            appData.selectedUserFilter = selectedUserFilter;
            appData.editingEventId = editingEventId;
            appData.schedules = schedules;
            appData.projects = projects;
            appData.projectFiles = projectFiles;
            appData.currentProjectId = currentProjectId;
        }

        function syncFromAppData() {
            currentUser = appData.currentUser;
            selectedDepartment = appData.selectedDepartment;
            selectedEmployee = appData.selectedEmployee;
            viewMode = appData.viewMode;
            currentDate = appData.currentDate || new Date();
            selectedUserFilter = appData.selectedUserFilter;
            editingEventId = appData.editingEventId;
            schedules = appData.schedules || [];
            projects = appData.projects || [];
            projectFiles = appData.projectFiles || {};
            currentProjectId = appData.currentProjectId;
        }

        // === Dropbox連携機能 ===
        function connectToDropbox() {
            updateSyncStatus('pending', 'Dropbox接続中...');
            
            // 実際のDropbox APIキーが必要
            if (DROPBOX_APP_KEY === 'YOUR_DROPBOX_APP_KEY') {
                showDropboxSetupDialog();
                return;
            }

            try {
                dropboxAuth = new Dropbox.Dropbox({ 
                    clientId: DROPBOX_APP_KEY,
                    fetch: fetch
                });

                const authUrl = dropboxAuth.getAuthenticationUrl('http://localhost:8080/auth');
                window.open(authUrl, '_blank');
                
                // 認証完了の検証（簡易版）
                setTimeout(() => {
                    isDropboxConnected = true;
                    updateDropboxStatus();
                    updateSyncStatus('success', 'Dropbox接続完了');
                }, 3000);
                
            } catch (error) {
                console.error('Dropbox接続エラー:', error);
                updateSyncStatus('error', 'Dropbox接続失敗');
            }
        }

        function showDropboxSetupDialog() {
            const setupHtml = `
                <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                        <h3 class="text-xl font-bold text-blue-700 mb-4 flex items-center space-x-2">
                            <span>📁</span>
                            <span>Dropbox API設定</span>
                        </h3>
                        <div class="space-y-4 text-sm">
                            <p class="text-gray-700">Dropbox連携を有効にするには、以下の手順が必要です：</p>
                            <ol class="list-decimal list-inside space-y-2 text-gray-600">
                                <li>Dropbox App Consoleでアプリを作成</li>
                                <li>App Keyを取得</li>
                                <li>コード内のYOUR_DROPBOX_APP_KEYを置き換え</li>
                                <li>認証URLを設定</li>
                            </ol>
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <p class="text-blue-700 font-medium">現在はデモモードで動作中</p>
                                <p class="text-blue-600 text-xs">実際の同期にはAPI設定が必要です</p>
                            </div>
                        </div>
                        <button onclick="closeDropboxSetup()" 
                                class="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-bold">
                            了解
                        </button>
                    </div>
                </div>
            `;
            
            const div = document.createElement('div');
            div.id = 'dropboxSetup';
            div.innerHTML = setupHtml;
            document.body.appendChild(div);
            
            updateSyncStatus('offline', 'Dropbox未設定');
        }

        function closeDropboxSetup() {
            const setup = document.getElementById('dropboxSetup');
            if (setup) {
                setup.remove();
            }
        }

        async function syncToDropbox() {
            if (!isDropboxConnected) {
                updateSyncStatus('error', 'Dropbox未接続');
                return false;
            }

            try {
                updateSyncStatus('pending', 'Dropbox同期中...');
                
                syncToAppData();
                const dataToSync = {
                    ...appData,
                    syncTime: new Date().toISOString()
                };

                // Dropboxにデータをアップロード
                await dropboxAuth.filesUpload({
                    path: '/schedule_data.json',
                    contents: JSON.stringify(dataToSync, null, 2),
                    mode: 'overwrite',
                    autorename: true
                });

                appData.lastSyncTime = new Date().toISOString();
                updateSyncStatus('success', 'Dropbox同期完了');
                return true;
                
            } catch (error) {
                console.error('Dropbox同期エラー:', error);
                updateSyncStatus('error', 'Dropbox同期失敗');
                return false;
            }
        }

        async function syncFromDropbox() {
            if (!isDropboxConnected) {
                return false;
            }

            try {
                updateSyncStatus('pending', 'Dropboxから取得中...');
                
                const response = await dropboxAuth.filesDownload({
                    path: '/schedule_data.json'
                });

                if (response.result.fileBinary) {
                    const text = new TextDecoder().decode(response.result.fileBinary);
                    const data = JSON.parse(text);
                    
                    // データをマージ（ローカルの方が新しい場合は保持）
                    if (data.syncTime && (!appData.lastSyncTime || new Date(data.syncTime) > new Date(appData.lastSyncTime))) {
                        appData = { ...DEFAULT_DATA, ...data };
                        if (data.currentDate) {
                            appData.currentDate = new Date(data.currentDate);
                        }
                        syncFromAppData();
                        updateSyncStatus('success', 'Dropboxから更新');
                        return true;
                    }
                }
                
            } catch (error) {
                if (error.status === 409) {
                    // ファイルが存在しない場合
                    updateSyncStatus('success', 'Dropbox初回同期');
                } else {
                    console.error('Dropbox取得エラー:', error);
                    updateSyncStatus('error', 'Dropbox取得失敗');
                }
            }
            return false;
        }

        // === 同期機能 ===
        async function syncData() {
            // ローカルストレージに保存
            saveToLocalStorage();
            
            // Dropboxに同期（利用可能な場合）
            if (isDropboxConnected) {
                await syncToDropbox();
            }
        }

        function updateSyncStatus(status, message) {
            const statusElement = document.getElementById('syncStatus');
            const textElement = document.getElementById('syncStatusText');
            
            statusElement.className = `sync-status sync-${status}`;
            textElement.textContent = message;
            statusElement.classList.remove('hidden');
            
            // 3秒後に自動で隠す
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 3000);
        }

        function updateDropboxStatus() {
            const icon = document.getElementById('dropboxIcon');
            const text = document.getElementById('dropboxStatusText');
            const btn = document.getElementById('dropboxConnectBtn');
            
            if (isDropboxConnected) {
                icon.textContent = '☁️✅';
                text.textContent = 'Dropbox接続済み';
                text.className = 'text-green-700 font-medium';
                btn.textContent = '🔄 同期';
                btn.onclick = syncData;
                btn.className = 'mt-2 w-full px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-bold';
            } else {
                icon.textContent = '☁️';
                text.textContent = 'Dropbox未接続';
                text.className = 'text-blue-700 font-medium';
                btn.textContent = '📁 Dropboxに接続';
                btn.onclick = connectToDropbox;
            }
        }

        // === データインポート/エクスポート機能 ===
        function exportData() {
            try {
                syncToAppData();
                const dataToExport = {
                    ...appData,
                    exportTime: new Date().toISOString(),
                    exportVersion: '1.0.0'
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `schedule_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                updateSyncStatus('success', 'データエクスポート完了');
            } catch (error) {
                console.error('エクスポートエラー:', error);
                updateSyncStatus('error', 'エクスポート失敗');
            }
        }

        function importData() {
            document.getElementById('importFileInput').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // データの検証
                    if (data.version || data.exportVersion) {
                        if (confirm('バックアップファイルからデータを復元しますか？\n現在のデータは上書きされます。')) {
                            appData = { ...DEFAULT_DATA, ...data };
                            if (data.currentDate) {
                                appData.currentDate = new Date(data.currentDate);
                            }
                            syncFromAppData();
                            saveToLocalStorage();
                            
                            // 画面を更新
                            if (currentUser) {
                                restoreLoginState();
                            }
                            
                            updateSyncStatus('success', 'データインポート完了');
                        }
                    } else {
                        alert('無効なバックアップファイルです。');
                    }
                } catch (error) {
                    console.error('インポートエラー:', error);
                    alert('ファイルの読み込みに失敗しました。');
                    updateSyncStatus('error', 'インポート失敗');
                }
            };
            reader.readAsText(file);
            
            // ファイル入力をリセット
            event.target.value = '';
        }

        // === ファイル共有機能（簡略版） ===
        function showFileSharing() {
            alert('ファイル共有機能は開発中です。\n現在はスケジュール管理機能をご利用ください。');
        }

        // === ユーティリティ関数 ===
        function getEmployeeName(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.name : '不明';
        }

        function getEmployeeEmoji(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.emoji : '👤';
        }

        function getEmployeeColor(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.color : '#6b7280';
        }

        function getEmployeeDepartment(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.department : '不明';
        }

        // === ログイン機能 ===
        function selectDepartment(dept) {
            selectedDepartment = dept;
            selectedEmployee = '';
            
            // 部署ボタンのスタイル更新
            document.querySelectorAll('[id^="dept-"]').forEach(btn => {
                btn.className = 'w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105';
            });
            document.getElementById(`dept-${dept}`).className = 'w-full p-3 rounded-xl border-2 border-purple-400 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 shadow-lg transition-all duration-300 transform hover:scale-105';
            
            // 社員選択セクションを表示
            const employeeSection = document.getElementById('employeeSection');
            const employeeList = document.getElementById('employeeList');
            
            employeeSection.className = 'animate-fadeIn';
            employeeList.innerHTML = '';
            
            departments[dept].forEach(emp => {
                const button = document.createElement('button');
                button.onclick = () => selectEmployee(emp.id);
                button.id = `emp-${emp.id}`;
                button.className = 'p-2 rounded-lg border border-gray-300 hover:border-pink-300 hover:bg-pink-50 bg-white transition-all duration-300 transform hover:scale-105';
                button.innerHTML = `
                    <div class="flex flex-col items-center space-y-1">
                        <span class="text-lg">${emp.emoji}</span>
                        <span class="text-xs font-bold">${emp.name}</span>
                    </div>
                `;
                employeeList.appendChild(button);
            });
            
            updateLoginButton();
        }

        function selectEmployee(empId) {
            selectedEmployee = empId;
            
            // 社員ボタンのスタイル更新
            document.querySelectorAll('[id^="emp-"]').forEach(btn => {
                btn.className = 'p-2 rounded-lg border border-gray-300 hover:border-pink-300 hover:bg-pink-50 bg-white transition-all duration-300 transform hover:scale-105';
            });
            document.getElementById(`emp-${empId}`).className = 'p-2 rounded-lg border-2 border-pink-400 bg-gradient-to-r from-pink-100 to-purple-100 text-pink-700 shadow-md transition-all duration-300 transform hover:scale-105';
            
            // パスワード入力セクションを表示
            document.getElementById('passwordSection').className = 'animate-fadeIn';
            
            updateLoginButton();
        }

        function updateLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            const canLogin = selectedDepartment && selectedEmployee && document.getElementById('passwordInput').value;
            
            if (canLogin) {
                loginBtn.disabled = false;
                loginBtn.className = 'w-full mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 font-bold transform hover:scale-105 hover:shadow-lg flex items-center justify-center space-x-2';
            } else {
                loginBtn.disabled = true;
                loginBtn.className = 'w-full mt-4 bg-gradient-to-r from-gray-300 to-gray-400 text-white py-3 rounded-xl font-bold cursor-not-allowed transition-all duration-300 flex items-center justify-center space-x-2';
            }
        }

        function handleLogin() {
            const password = document.getElementById('passwordInput').value;
            const loginError = document.getElementById('loginError');
            
            if (!selectedDepartment) {
                showError('🏢 部署を選択してください');
                return;
            }
            if (!selectedEmployee) {
                showError('👤 社員を選択してください');
                return;
            }
            if (!password) {
                showError('🔑 パスワードを入力してください');
                return;
            }

            const employee = allEmployees.find(emp => emp.id === parseInt(selectedEmployee));
            if (employee && employee.password === password) {
                currentUser = employee;
                
                // ユーザー情報を表示
                document.getElementById('currentUserName').innerHTML = `
                    <span>${employee.emoji}</span>
                    <span>${employee.name}</span>
                `;
                document.getElementById('currentUserDept').textContent = employee.department;
                
                // ユーザーフィルターにオプション追加
                const userFilter = document.getElementById('userFilter');
                userFilter.innerHTML = '<option value="all">🌟 全員</option>';
                allEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.emoji} ${emp.name}`;
                    userFilter.appendChild(option);
                });
                
                // 画面切り替え
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                
                // カレンダー初期化
                updateCalendar();
                
                // データ保存
                saveToLocalStorage();
                
                loginError.classList.add('hidden');
            } else {
                showError('❌ パスワードが正しくありません');
            }
        }

        function showError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }

        function handleLogout() {
            currentUser = null;
            selectedDepartment = '';
            selectedEmployee = '';
            
            // フォームリセット
            document.getElementById('passwordInput').value = '';
            document.getElementById('employeeSection').classList.add('hidden');
            document.getElementById('passwordSection').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            
            // ボタンスタイルリセット
            document.querySelectorAll('[id^="dept-"]').forEach(btn => {
                btn.className = 'w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105';
            });
            
            // 画面切り替え
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            updateLoginButton();
        }

        // === 表示モード切り替え ===
        function setViewMode(mode) {
            viewMode = mode;
            
            if (mode === 'calendar') {
                document.getElementById('calendarModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold transition-all duration-300 transform hover:scale-105';
                document.getElementById('cybozuModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-purple-100 hover:to-pink-100 font-bold transition-all duration-300 transform hover:scale-105';
                
                document.getElementById('calendarControls').classList.remove('hidden');
                document.getElementById('cybozuControls').classList.add('hidden');
                document.getElementById('calendarView').classList.remove('hidden');
                document.getElementById('cybozuView').classList.add('hidden');
                
                updateCalendar();
            } else {
                document.getElementById('cybozuModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold transition-all duration-300 transform hover:scale-105';
                document.getElementById('calendarModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-purple-100 hover:to-pink-100 font-bold transition-all duration-300 transform hover:scale-105';
                
                document.getElementById('calendarControls').classList.add('hidden');
                document.getElementById('cybozuControls').classList.remove('hidden');
                document.getElementById('calendarView').classList.add('hidden');
                document.getElementById('cybozuView').classList.remove('hidden');
                
                updateCybozuView();
            }
        }

        // === カレンダー更新 ===
        function updateCalendar() {
            // 月表示更新
            document.getElementById('currentMonth').textContent = `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月`;
            
            // カレンダーグリッド生成
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date().toISOString().split('T')[0];

            for (let i = 0; i < 42; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                
                const daySchedules = getSchedulesForDate(day);
                const isCurrentMonth = day.getMonth() === month;
                const isToday = day.toISOString().split('T')[0] === today;
                
                const dayCell = document.createElement('div');
                dayCell.className = `calendar-cell border-r border-b border-purple-100 min-h-16 md:min-h-24 p-1 md:p-2 transition-all duration-300 hover:bg-purple-50 cursor-pointer ${
                    !isCurrentMonth ? 'bg-gray-50/50' : isToday ? 'bg-gradient-to-br from-yellow-100 to-orange-100' : ''
                }`;
                dayCell.onclick = () => addScheduleForDate(day);
                
                const dayNumber = document.createElement('div');
                dayNumber.className = `text-xs md:text-sm font-bold mb-1 flex items-center justify-center ${
                    isToday ? 'bg-gradient-to-r from-orange-400 to-pink-400 text-white rounded-full w-5 h-5 md:w-6 md:h-6 text-xs' :
                    i % 7 === 0 ? 'text-red-500' : 
                    i % 7 === 6 ? 'text-blue-500' : 
                    'text-purple-700'
                }`;
                dayNumber.innerHTML = `${isToday ? '<span class="text-xs">🎯</span>' : ''}${day.getDate()}`;
                
                const scheduleContainer = document.createElement('div');
                scheduleContainer.className = 'space-y-1';
                
                // モバイルでは1件、デスクトップでは2件表示
                const maxSchedules = window.innerWidth <= 768 ? 1 : 2;
                
                daySchedules.slice(0, maxSchedules).forEach(schedule => {
                    const scheduleDiv = document.createElement('div');
                    scheduleDiv.className = 'schedule-item text-xs p-1 rounded cursor-pointer hover:opacity-80 transition-all duration-300 transform hover:scale-105 shadow-sm';
                    scheduleDiv.style.backgroundColor = `${getEmployeeColor(schedule.employeeIds[0])}30`;
                    scheduleDiv.style.borderLeft = `2px md:3px solid ${getEmployeeColor(schedule.employeeIds[0])}`;
                    scheduleDiv.onclick = (e) => {
                        e.stopPropagation();
                        editSchedule(schedule.id);
                    };
                    
                    scheduleDiv.innerHTML = `
                        <div class="font-bold truncate text-xs">${schedule.title}</div>
                        <div class="text-gray-700 flex items-center space-x-1 text-xs">
                            <span class="text-xs">${getEmployeeEmoji(schedule.employeeIds[0])}</span>
                            <span class="truncate">
                                ${schedule.employeeIds.length > 1 ? `${getEmployeeName(schedule.employeeIds[0])} 他${schedule.employeeIds.length - 1}名` : getEmployeeName(schedule.employeeIds[0])}
                            </span>
                        </div>
                    `;
                    scheduleContainer.appendChild(scheduleDiv);
                });
                
                if (daySchedules.length > maxSchedules) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'text-xs text-purple-600 font-bold';
                    moreDiv.textContent = `✨ 他${daySchedules.length - maxSchedules}件`;
                    scheduleContainer.appendChild(moreDiv);
                }
                
                dayCell.appendChild(dayNumber);
                dayCell.appendChild(scheduleContainer);
                calendarGrid.appendChild(dayCell);
            }
        }

        // === サイボウズ風表示更新 ===
        function updateCybozuView() {
            const weekDays = generateWeekDays();
            document.getElementById('currentWeek').textContent = 
                `${weekDays[0].getFullYear()}年${weekDays[0].getMonth() + 1}月${weekDays[0].getDate()}日〜${weekDays[6].getMonth() + 1}月${weekDays[6].getDate()}日`;
            
            if (window.innerWidth <= 768) {
                updateMobileCybozuView(weekDays);
            } else {
                updateDesktopCybozuView(weekDays);
            }
        }

        // モバイル版サイボウズ表示
        function updateMobileCybozuView(weekDays) {
            const cybozuGrid = document.getElementById('cybozuGrid');
            cybozuGrid.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            
            // 各曜日ごとにセクションを作成
            weekDays.forEach((day, dayIndex) => {
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][day.getDay()];
                const dayEmoji = ['🌅', '🌙', '🔥', '💧', '🌳', '⭐', '🌈'][day.getDay()];
                const isToday = day.toISOString().split('T')[0] === today;
                
                const daySection = document.createElement('div');
                daySection.className = `border border-purple-200 rounded-xl mb-4 ${isToday ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}`;
                
                // 日付ヘッダー
                const dayHeader = document.createElement('div');
                dayHeader.className = `p-3 border-b border-purple-200 font-bold text-center ${
                    isToday ? 'bg-yellow-100 text-yellow-800' :
                    day.getDay() === 0 ? 'text-red-500' : 
                    day.getDay() === 6 ? 'text-blue-500' : 
                    'text-purple-700'
                }`;
                dayHeader.innerHTML = `
                    <div class="text-lg">${dayEmoji} ${day.getMonth() + 1}月${day.getDate()}日(${dayOfWeek})</div>
                    ${isToday ? '<div class="text-sm">✨ 今日 ✨</div>' : ''}
                `;
                daySection.appendChild(dayHeader);
                
                // 社員ごとの予定
                const employeesContainer = document.createElement('div');
                employeesContainer.className = 'p-3 space-y-3';
                
                Object.entries(departments).forEach(([dept, employees]) => {
                    const deptDiv = document.createElement('div');
                    deptDiv.innerHTML = `<h4 class="font-bold text-purple-700 mb-2 flex items-center space-x-2">
                        <span>${dept === '管理部' ? '🏢' : '🏗️'}</span>
                        <span>${dept}</span>
                    </h4>`;
                    
                    const empGrid = document.createElement('div');
                    empGrid.className = 'grid grid-cols-2 gap-3';
                    
                    employees.forEach(emp => {
                        const empData = allEmployees.find(e => e.id === emp.id);
                        const daySchedules = getSchedulesForEmployeeAndDate(emp.id, day);
                        
                        const empCard = document.createElement('div');
                        empCard.className = 'border border-gray-200 rounded-lg p-2 bg-gray-50';
                        
                        empCard.innerHTML = `
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${empData.color}"></div>
                                <span class="text-sm">${emp.emoji}</span>
                                <span class="text-sm font-bold text-purple-700">${emp.name}</span>
                            </div>
                            <div class="space-y-1">
                                ${daySchedules.map(schedule => {
                                    const startTime = new Date(schedule.startTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                                    return `
                                        <div class="text-xs p-2 rounded cursor-pointer hover:opacity-80" 
                                             style="background-color: ${empData.color}20; border-left: 3px solid ${empData.color}"
                                             onclick="editSchedule(${schedule.id})">
                                            <div class="font-bold">${schedule.title}</div>
                                            <div class="text-gray-600">${startTime}</div>
                                        </div>
                                    `;
                                }).join('')}
                                <div class="text-xs p-2 border border-dashed border-purple-300 rounded text-center cursor-pointer hover:bg-purple-50"
                                     onclick="addScheduleForEmployeeAndDate(${emp.id}, new Date('${day.toISOString()}'))">
                                    ✨ 予定追加
                                </div>
                            </div>
                        `;
                        
                        empGrid.appendChild(empCard);
                    });
                    
                    deptDiv.appendChild(empGrid);
                    employeesContainer.appendChild(deptDiv);
                });
                
                daySection.appendChild(employeesContainer);
                cybozuGrid.appendChild(daySection);
            });
        }

        // デスクトップ版サイボウズ表示
        function updateDesktopCybozuView(weekDays) {
            const cybozuGrid = document.getElementById('cybozuGrid');
            cybozuGrid.innerHTML = '';
            
            // ヘッダー行
            const headerRow = document.createElement('div');
            headerRow.className = 'cybozu-header';
            
            const employeeHeader = document.createElement('div');
            employeeHeader.className = 'cybozu-cell cybozu-name-cell font-bold text-purple-700 flex items-center justify-center';
            employeeHeader.textContent = '👥 社員名';
            headerRow.appendChild(employeeHeader);
            
            const today = new Date().toISOString().split('T')[0];
            
            weekDays.forEach((day, index) => {
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][day.getDay()];
                const dayEmoji = ['🌅', '🌙', '🔥', '💧', '🌳', '⭐', '🌈'][day.getDay()];
                const isToday = day.toISOString().split('T')[0] === today;
                
                const dayHeader = document.createElement('div');
                dayHeader.className = `cybozu-cell text-center font-bold ${
                    isToday ? 'bg-gradient-to-br from-yellow-200 to-orange-200 text-orange-700' :
                    day.getDay() === 0 ? 'text-red-500' : 
                    day.getDay() === 6 ? 'text-blue-500' : 
                    'text-purple-700'
                }`;
                
                dayHeader.innerHTML = `
                    <div class="flex items-center justify-center space-x-1">
                        <span>${dayEmoji}</span>
                        <span>${day.getMonth() + 1}/${day.getDate()}</span>
                    </div>
                    <div class="text-sm">(${dayOfWeek})</div>
                    ${isToday ? '<div class="text-xs">✨今日✨</div>' : ''}
                `;
                headerRow.appendChild(dayHeader);
            });
            
            cybozuGrid.appendChild(headerRow);
            
            // 部署別社員行
            Object.entries(departments).forEach(([dept, employees]) => {
                // 部署ヘッダー
                const deptHeaderRow = document.createElement('div');
                deptHeaderRow.className = 'cybozu-dept-header';
                
                const deptHeader = document.createElement('div');
                deptHeader.className = 'cybozu-cell font-bold text-purple-700 flex items-center space-x-2';
                deptHeader.style.gridColumn = '1 / -1';
                deptHeader.innerHTML = `
                    <span>${dept === '管理部' ? '🏢' : '🏗️'}</span>
                    <span>${dept}</span>
                    <span class="bg-white/60 px-2 py-1 rounded-full text-xs">(${employees.length}名)</span>
                `;
                deptHeaderRow.appendChild(deptHeader);
                cybozuGrid.appendChild(deptHeaderRow);
                
                // 各社員の行
                employees.forEach(emp => {
                    const empData = allEmployees.find(e => e.id === emp.id);
                    const empRow = document.createElement('div');
                    empRow.className = 'cybozu-row hover:bg-purple-50/50 transition-all duration-300';
                    
                    // 社員名
                    const empNameCell = document.createElement('div');
                    empNameCell.className = 'cybozu-cell cybozu-name-cell';
                    empNameCell.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full shadow-sm" style="background-color: ${empData.color}"></div>
                            <span class="text-lg">${emp.emoji}</span>
                            <span class="text-sm font-bold text-purple-700">${emp.name}</span>
                        </div>
                    `;
                    empRow.appendChild(empNameCell);
                    
                    // 各曜日の予定
                    weekDays.forEach(day => {
                        const daySchedules = getSchedulesForEmployeeAndDate(emp.id, day);
                        const isToday = day.toISOString().split('T')[0] === today;
                        
                        const dayCell = document.createElement('div');
                        dayCell.className = `cybozu-cell ${
                            isToday ? 'bg-gradient-to-br from-yellow-50 to-orange-50' : ''
                        }`;
                        
                        const scheduleContainer = document.createElement('div');
                        scheduleContainer.className = 'space-y-1';
                        
                        daySchedules.forEach(schedule => {
                            const scheduleDiv = document.createElement('div');
                            scheduleDiv.className = 'text-xs p-1 rounded cursor-pointer hover:opacity-80 transition-all duration-300 transform hover:scale-105 shadow-sm';
                            scheduleDiv.style.backgroundColor = `${getEmployeeColor(schedule.employeeIds[0])}30`;
                            scheduleDiv.style.borderLeft = `2px solid ${getEmployeeColor(schedule.employeeIds[0])}`;
                            scheduleDiv.onclick = (e) => {
                                e.stopPropagation();
                                editSchedule(schedule.id);
                            };
                            
                            const startTime = new Date(schedule.startTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                            
                            scheduleDiv.innerHTML = `
                                <div class="font-bold truncate">${schedule.title}</div>
                                <div class="text-gray-600 flex items-center space-x-1">
                                    <span>🕐</span>
                                    <span>${startTime}</span>
                                    ${schedule.employeeIds.length > 1 ? 
                                        `<span class="bg-purple-200 text-purple-700 px-1 rounded-full text-xs font-bold">+${schedule.employeeIds.length - 1}</span>` : ''
                                    }
                                </div>
                            `;
                            scheduleContainer.appendChild(scheduleDiv);
                        });
                        
                        // 予定追加ボタン
                        const addDiv = document.createElement('div');
                        addDiv.className = 'text-gray-400 text-xs p-1 cursor-pointer hover:bg-purple-100 rounded border border-dashed border-purple-200 transition-all duration-300 transform hover:scale-105 text-center mt-1';
                        addDiv.onclick = (e) => {
                            e.stopPropagation();
                            addScheduleForEmployeeAndDate(emp.id, day);
                        };
                        addDiv.innerHTML = '<div>✨</div><div>予定追加</div>';
                        scheduleContainer.appendChild(addDiv);
                        
                        dayCell.appendChild(scheduleContainer);
                        empRow.appendChild(dayCell);
                    });
                    
                    cybozuGrid.appendChild(empRow);
                });
            });
        }

        // === 週間日付生成 ===
        function generateWeekDays() {
            const startOfWeek = new Date(currentDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
            startOfWeek.setDate(diff);

            const days = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                days.push(day);
            }
            return days;
        }

        // === 指定日のスケジュール取得 ===
        function getSchedulesForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return schedules.filter(schedule => {
                const scheduleDate = schedule.startTime.split('T')[0];
                const matchesDate =
