<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Truth スケジュール管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-10px,0); }
            70% { transform: translate3d(0,-5px,0); }
            90% { transform: translate3d(0,-2px,0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        .hidden { display: none; }
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
        .bg-white\/90 { background-color: rgba(255, 255, 255, 0.9); }
        .bg-white\/80 { background-color: rgba(255, 255, 255, 0.8); }
        .bg-white\/70 { background-color: rgba(255, 255, 255, 0.7); }
        .bg-white\/60 { background-color: rgba(255, 255, 255, 0.6); }
        .bg-white\/50 { background-color: rgba(255, 255, 255, 0.5); }
        .bg-black\/50 { background-color: rgba(0, 0, 0, 0.5); }
        
        /* モバイル対応 */
        @media (max-width: 768px) {
            .calendar-grid {
                font-size: 0.75rem;
            }
            .calendar-cell {
                min-height: 4rem !important;
                padding: 0.25rem !important;
            }
            .schedule-item {
                font-size: 0.6rem !important;
                padding: 0.125rem 0.25rem !important;
                margin-bottom: 0.125rem !important;
            }
            .mobile-header {
                padding: 0.75rem !important;
            }
            .mobile-controls {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            .mobile-button {
                font-size: 0.75rem !important;
                padding: 0.5rem 0.75rem !important;
            }
            .mobile-modal {
                margin: 0.5rem !important;
            }
            .cybozu-grid {
                font-size: 0.7rem;
            }
            .cybozu-employee-cell {
                min-width: 100px !important;
                max-width: 100px !important;
            }
            .cybozu-day-cell {
                min-width: 45px !important;
                padding: 0.25rem !important;
            }
            .cybozu-day-header {
                padding: 0.375rem 0.125rem !important;
                font-size: 0.65rem !important;
            }
            .cybozu-schedule-item {
                font-size: 0.55rem !important;
                padding: 0.125rem !important;
                margin-bottom: 0.125rem !important;
                line-height: 1.2 !important;
            }
            .cybozu-add-button {
                font-size: 0.55rem !important;
                padding: 0.125rem !important;
                line-height: 1.2 !important;
            }
            .cybozu-employee-name {
                font-size: 0.6rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-pink-100 via-purple-50 to-indigo-100 flex items-center justify-center p-4">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-10 left-10 text-4xl animate-bounce">✨</div>
            <div class="absolute top-20 right-20 text-3xl animate-pulse">🌟</div>
            <div class="absolute bottom-20 left-20 text-4xl animate-bounce">💫</div>
            <div class="absolute bottom-10 right-10 text-2xl animate-pulse">⭐</div>
        </div>
        
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl w-full max-w-md p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400"></div>
            
            <div class="text-center mb-6">
                <div class="text-4xl mb-3 animate-pulse">🎯</div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-1">
                    The truth
                </h1>
                <p class="text-gray-600 font-medium">株式会社大真工業</p>
                <p class="text-sm text-gray-500 flex items-center justify-center space-x-1">
                    <span>✨</span>
                    <span>スケジュール管理システム</span>
                    <span>✨</span>
                </p>
            </div>

            <div class="space-y-4">
                <!-- 部署選択 -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center space-x-2">
                        <span>🏢</span>
                        <span>部署を選択してください</span>
                    </label>
                    <div class="space-y-2">
                        <button onclick="selectDepartment('管理部')" id="dept-管理部" 
                                class="w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xl">🏢</span>
                                    <span class="font-bold">管理部</span>
                                </div>
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-bold">4名</span>
                            </div>
                        </button>
                        <button onclick="selectDepartment('工事部')" id="dept-工事部"
                                class="w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xl">🏗️</span>
                                    <span class="font-bold">工事部</span>
                                </div>
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-bold">9名</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- 社員選択 -->
                <div id="employeeSection" class="hidden animate-fadeIn">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center space-x-2">
                        <span>👤</span>
                        <span>社員を選択してください</span>
                    </label>
                    <div id="employeeList" class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto p-2 bg-gray-50/50 rounded-xl">
                    </div>
                </div>

                <!-- パスワード入力 -->
                <div id="passwordSection" class="hidden animate-fadeIn">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center space-x-2">
                        <span>🔑</span>
                        <span>パスワードを入力してください</span>
                    </label>
                    <div class="relative">
                        <input type="password" id="passwordInput"
                               class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                               placeholder="パスワードを入力してね 🔐"
                               onkeypress="if(event.key==='Enter') handleLogin()">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xl">🔐</div>
                    </div>
                </div>
            </div>

            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm"></div>

            <button onclick="handleLogin()" id="loginBtn"
                    class="w-full mt-4 bg-gradient-to-r from-gray-300 to-gray-400 text-white py-3 rounded-xl font-bold cursor-not-allowed transition-all duration-300 flex items-center justify-center space-x-2"
                    disabled>
                <span>🚀</span>
                <span>ログイン</span>
                <span>✨</span>
            </button>
            
            <button onclick="showFileSharing()"
                    class="w-full mt-3 bg-gradient-to-r from-green-500 to-teal-500 text-white py-3 rounded-xl hover:from-green-600 hover:to-teal-600 transition-all duration-300 font-bold transform hover:scale-105 shadow-lg flex items-center justify-center space-x-2">
                <span>📁</span>
                <span>物件ファイル共有</span>
                <span>📋</span>
            </button>
        </div>
    </div>

    <!-- ファイル共有画面 -->
    <div id="fileSharingScreen" class="hidden min-h-screen bg-gradient-to-br from-green-50 via-teal-50 to-blue-50">
        <!-- ヘッダー -->
        <header class="bg-gradient-to-r from-green-600 via-teal-500 to-blue-600 text-white mobile-header shadow-xl">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="text-xl md:text-2xl animate-pulse">📁</div>
                    <div>
                        <h1 class="text-sm md:text-xl font-bold flex items-center space-x-1 md:space-x-2">
                            <span>物件ファイル共有</span>
                            <span class="animate-spin text-xs md:text-sm">📋</span>
                        </h1>
                        <p class="text-green-100 text-xs md:text-sm hidden md:block">株式会社大真工業 ✨ ファイル管理システム</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-3">
                    <button onclick="showCreateProjectModal()"
                            class="mobile-button bg-gradient-to-r from-yellow-400 to-orange-400 hover:from-yellow-500 hover:to-orange-500 px-2 md:px-4 py-1 md:py-2 rounded-xl flex items-center space-x-1 md:space-x-2 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold">
                        <span>➕</span>
                        <span class="hidden md:inline">新規物件</span>
                    </button>
                    <button onclick="backToLogin()"
                            class="mobile-button bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 p-1 md:p-2 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg"
                            title="戻る">
                        <span>🏠</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-6xl mx-auto p-4">
            <!-- 物件一覧 -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-lg p-6 mb-4 border border-green-100">
                <h2 class="text-xl font-bold text-green-700 mb-4 flex items-center space-x-2">
                    <span>🏗️</span>
                    <span>物件一覧</span>
                </h2>
                <div id="projectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 物件カードがここに動的に追加される -->
                </div>
                <div id="noProjects" class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">📂</div>
                    <p>まだ物件が登録されていません</p>
                    <p class="text-sm">「新規物件」ボタンから物件を追加してください</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 物件詳細画面 -->
    <div id="projectDetailScreen" class="hidden min-h-screen bg-gradient-to-br from-green-50 via-teal-50 to-blue-50">
        <!-- ヘッダー -->
        <header class="bg-gradient-to-r from-green-600 via-teal-500 to-blue-600 text-white mobile-header shadow-xl">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="text-xl md:text-2xl animate-pulse">📋</div>
                    <div>
                        <h1 id="projectDetailTitle" class="text-sm md:text-xl font-bold"></h1>
                        <p class="text-green-100 text-xs md:text-sm hidden md:block">物件ファイル管理</p>
                    </div>
                </div>
                <button onclick="backToFileSharing()"
                        class="mobile-button bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 p-1 md:p-2 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg"
                        title="戻る">
                    <span>←</span>
                </button>
            </div>
        </header>

        <div class="max-w-6xl mx-auto p-4">
            <!-- ファイルカテゴリ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-green-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4">
                        <h3 class="font-bold flex items-center space-x-2">
                            <span>🗺️</span>
                            <span>現場案内図</span>
                        </h3>
                    </div>
                    <div class="p-4">
                        <input type="file" id="siteMap" accept=".pdf,.jpg,.jpeg,.png" multiple class="hidden">
                        <button onclick="document.getElementById('siteMap').click()" 
                                class="w-full mb-3 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center space-x-2">
                            <span>📤</span>
                            <span>アップロード</span>
                        </button>
                        <div id="siteMapFiles" class="space-y-2">
                        </div>
                    </div>
                </div>

                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-green-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-teal-500 text-white p-4">
                        <h3 class="font-bold flex items-center space-x-2">
                            <span>📅</span>
                            <span>工程表</span>
                        </h3>
                    </div>
                    <div class="p-4">
                        <input type="file" id="schedule" accept=".pdf,.xls,.xlsx" multiple class="hidden">
                        <button onclick="document.getElementById('schedule').click()" 
                                class="w-full mb-3 px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                            <span>📤</span>
                            <span>アップロード</span>
                        </button>
                        <div id="scheduleFiles" class="space-y-2">
                        </div>
                    </div>
                </div>

                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-green-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4">
                        <h3 class="font-bold flex items-center space-x-2">
                            <span>📐</span>
                            <span>図面データ</span>
                        </h3>
                    </div>
                    <div class="p-4">
                        <input type="file" id="drawings" accept=".pdf,.dwg,.jpg,.jpeg,.png" multiple class="hidden">
                        <button onclick="document.getElementById('drawings').click()" 
                                class="w-full mb-3 px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors flex items-center justify-center space-x-2">
                            <span>📤</span>
                            <span>アップロード</span>
                        </button>
                        <div id="drawingsFiles" class="space-y-2">
                        </div>
                    </div>
                </div>

                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-green-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4">
                        <h3 class="font-bold flex items-center space-x-2">
                            <span>👷</span>
                            <span>新規・送り出し教育</span>
                        </h3>
                    </div>
                    <div class="p-4">
                        <input type="file" id="training" accept=".pdf,.ppt,.pptx,.doc,.docx" multiple class="hidden">
                        <button onclick="document.getElementById('training').click()" 
                                class="w-full mb-3 px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors flex items-center justify-center space-x-2">
                            <span>📤</span>
                            <span>アップロード</span>
                        </button>
                        <div id="trainingFiles" class="space-y-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新規物件作成モーダル -->
    <div id="createProjectModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl w-full max-w-md shadow-2xl border border-green-200">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-green-700 flex items-center space-x-2">
                        <span>🏗️</span>
                        <span>新規物件作成</span>
                    </h2>
                    <button onclick="closeCreateProjectModal()" class="text-gray-500 hover:text-green-600 transition-colors">
                        <span class="text-2xl">×</span>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-green-700 mb-2 flex items-center space-x-1">
                            <span>🏗️</span>
                            <span>物件名</span>
                        </label>
                        <input type="text" id="projectName"
                               class="w-full border-2 border-green-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-green-400 focus:border-green-400 transition-all duration-300"
                               placeholder="物件名を入力してください">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-green-700 mb-2 flex items-center space-x-1">
                            <span>📝</span>
                            <span>説明（任意）</span>
                        </label>
                        <textarea id="projectDescription"
                                  class="w-full border-2 border-green-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-green-400 focus:border-green-400 transition-all duration-300"
                                  rows="3" placeholder="物件の詳細説明"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-green-200">
                    <button onclick="closeCreateProjectModal()"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 bg-gray-200 hover:bg-gray-300 rounded-xl transition-all duration-300 font-bold">
                        キャンセル
                    </button>
                    <button onclick="createProject()"
                            class="px-6 py-2 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl hover:from-green-600 hover:to-teal-600 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold flex items-center space-x-2">
                        <span>🏗️</span>
                        <span>作成</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- メイン画面 -->
    <div id="mainScreen" class="hidden min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
        <!-- ヘッダー -->
        <header class="bg-gradient-to-r from-purple-600 via-pink-500 to-indigo-600 text-white mobile-header shadow-xl">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="text-xl md:text-2xl animate-pulse">🎯</div>
                    <div>
                        <h1 class="text-sm md:text-xl font-bold flex items-center space-x-1 md:space-x-2">
                            <span>The truth</span>
                            <span class="animate-spin text-xs md:text-sm">✨</span>
                        </h1>
                        <p class="text-purple-100 text-xs md:text-sm hidden md:block">株式会社大真工業 ✨ スケジュール管理システム</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="text-right bg-white/20 rounded-xl p-1 md:p-2 backdrop-blur-sm">
                        <p id="currentUserName" class="font-bold text-xs md:text-sm flex items-center space-x-1"></p>
                        <p id="currentUserDept" class="text-xs text-purple-100 hidden md:block"></p>
                    </div>
                    <button onclick="showAddModal()"
                            class="mobile-button bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500 px-2 md:px-4 py-1 md:py-2 rounded-xl flex items-center space-x-1 md:space-x-2 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold">
                        <span>➕</span>
                        <span class="hidden md:inline">予定追加</span>
                    </button>
                    <button onclick="handleLogout()"
                            class="mobile-button bg-gradient-to-r from-red-400 to-pink-400 hover:from-red-500 hover:to-pink-500 p-1 md:p-2 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg"
                            title="ログアウト">
                        <span>🚪</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-6xl mx-auto p-4">
            <!-- 表示モード切替・コントロール -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-lg p-3 md:p-4 mb-4 border border-purple-100">
                <div class="mobile-controls flex flex-wrap items-center justify-between gap-3">
                    <!-- 表示モード切替 -->
                    <div class="flex rounded-xl overflow-hidden shadow-sm w-full md:w-auto">
                        <button onclick="setViewMode('calendar')" id="calendarModeBtn"
                                class="mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold transition-all duration-300 transform hover:scale-105">
                            <span class="md:hidden">📅</span>
                            <span class="hidden md:inline">📅 カレンダー表示</span>
                        </button>
                        <button onclick="setViewMode('cybozu')" id="cybozuModeBtn"
                                class="mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-purple-100 hover:to-pink-100 font-bold transition-all duration-300 transform hover:scale-105">
                            <span class="md:hidden">👥</span>
                            <span class="hidden md:inline">👥 社員別表示</span>
                        </button>
                    </div>
                    
                    <!-- カレンダーコントロール -->
                    <div id="calendarControls" class="flex flex-col md:flex-row items-stretch md:items-center space-y-2 md:space-y-0 md:space-x-3 w-full md:w-auto">
                        <div class="flex items-center space-x-2 bg-white/50 rounded-xl p-2">
                            <span class="text-xs md:text-sm">👤</span>
                            <select id="userFilter" onchange="filterByUser()" 
                                    class="border border-purple-200 rounded-lg px-2 py-1 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 bg-white/80 text-xs md:text-sm min-w-0 flex-1">
                                <option value="all">🌟 全員</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center justify-center space-x-2 bg-white/50 rounded-xl p-2">
                            <button onclick="previousMonth()"
                                    class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white rounded-lg hover:from-purple-500 hover:to-pink-500 transition-all duration-300 transform hover:scale-105 font-bold">
                                ◀
                            </button>
                            <span id="currentMonth" class="text-xs md:text-sm font-bold text-purple-700 min-w-20 md:min-w-24 text-center"></span>
                            <button onclick="nextMonth()"
                                    class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white rounded-lg hover:from-purple-500 hover:to-pink-500 transition-all duration-300 transform hover:scale-105 font-bold">
                                ▶
                            </button>
                        </div>
                    </div>

                    <!-- サイボウズコントロール -->
                    <div id="cybozuControls" class="hidden flex items-center justify-center space-x-2 bg-white/50 rounded-xl p-2 w-full md:w-auto">
                        <button onclick="previousWeek()"
                                class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-pink-400 to-purple-400 text-white rounded-lg hover:from-pink-500 hover:to-purple-500 transition-all duration-300 transform hover:scale-105 font-bold">
                            ◀
                        </button>
                        <span id="currentWeek" class="text-xs md:text-sm font-bold text-purple-700 text-center flex-1"></span>
                        <button onclick="nextWeek()"
                                class="mobile-button px-2 md:px-3 py-1 bg-gradient-to-r from-pink-400 to-purple-400 text-white rounded-lg hover:from-pink-500 hover:to-purple-500 transition-all duration-300 transform hover:scale-105 font-bold">
                            ▶
                        </button>
                    </div>
                </div>
            </div>

            <!-- カレンダー表示 -->
            <div id="calendarView" class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden border border-purple-100">
                <div class="grid grid-cols-7 bg-gradient-to-r from-purple-100 to-pink-100 border-b border-purple-200">
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-red-500">🌅<span class="hidden md:inline"> 日</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">🌙<span class="hidden md:inline"> 月</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">🔥<span class="hidden md:inline"> 火</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">💧<span class="hidden md:inline"> 水</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">🌳<span class="hidden md:inline"> 木</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-purple-700">⭐<span class="hidden md:inline"> 金</span></div>
                    <div class="p-2 md:p-3 text-center font-bold text-xs md:text-sm text-blue-500">🌈<span class="hidden md:inline"> 土</span></div>
                </div>
                <div id="calendarGrid" class="calendar-grid grid grid-cols-7">
                </div>
            </div>

            <!-- サイボウズ風表示 -->
            <div id="cybozuView" class="hidden bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg overflow-x-auto border border-purple-100">
                <div id="cybozuGrid" class="cybozu-grid min-w-full">
                </div>
            </div>
        </div>
    </div>

    <!-- スケジュール追加モーダル -->
    <div id="addModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-2 md:p-4">
        <div class="mobile-modal bg-white/95 backdrop-blur-sm rounded-2xl w-full max-w-lg max-h-screen overflow-y-auto shadow-2xl border border-purple-200">
            <div class="p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg md:text-xl font-bold text-purple-700 flex items-center space-x-2">
                        <span>🎉</span>
                        <span>新しい予定</span>
                        <span>✨</span>
                    </h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-purple-600 transition-colors">
                        <span class="text-2xl">×</span>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>🎯</span>
                            <span>タイトル</span>
                        </label>
                        <input type="text" id="eventTitle"
                               class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                               placeholder="楽しい予定のタイトルを入力してね 🌟">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>👥</span>
                            <span>対象者（複数選択可）</span>
                        </label>
                        <div id="employeeCheckboxes" class="border-2 border-purple-200 rounded-xl p-3 max-h-32 overflow-y-auto bg-purple-50/50">
                        </div>
                        <div id="selectedEmployees" class="hidden mt-2 p-2 bg-purple-100 rounded-xl">
                            <div class="text-sm text-purple-700 font-bold">
                                ✨ 選択中: <span id="selectedEmployeesList"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📝</span>
                            <span>種類</span>
                        </label>
                        <select id="eventType"
                                class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 bg-white/80 font-bold">
                            <option value="site">🏗️ 現場</option>
                            <option value="meeting">💬 打合せ</option>
                            <option value="leave">🌴 休暇</option>
                            <option value="training">📚 研修</option>
                            <option value="other">✨ その他</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕐</span>
                                <span>開始時間</span>
                            </label>
                            <input type="datetime-local" id="eventStartTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕑</span>
                                <span>終了時間</span>
                            </label>
                            <input type="datetime-local" id="eventEndTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📋</span>
                            <span>詳細</span>
                        </label>
                        <textarea id="eventDescription"
                                  class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                                  rows="3" placeholder="予定の詳細を入力してね ✨"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-purple-200">
                    <button onclick="closeModal()"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 bg-gray-200 hover:bg-gray-300 rounded-xl transition-all duration-300 font-bold">
                        キャンセル
                    </button>
                    <button onclick="addSchedule()"
                            class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold flex items-center space-x-2">
                        <span>🎉</span>
                        <span>追加</span>
                        <span>✨</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- スケジュール編集モーダル -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-2 md:p-4">
        <div class="mobile-modal bg-white/95 backdrop-blur-sm rounded-2xl w-full max-w-lg max-h-screen overflow-y-auto shadow-2xl border border-purple-200">
            <div class="p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg md:text-xl font-bold text-purple-700 flex items-center space-x-2">
                        <span>✏️</span>
                        <span>予定の編集</span>
                        <span>✨</span>
                    </h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-purple-600 transition-colors">
                        <span class="text-2xl">×</span>
                    </button>
                </div>
                
                <!-- 履歴情報 -->
                <div id="eventHistory" class="mb-4 p-3 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl border border-purple-200 text-sm text-purple-700">
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>🎯</span>
                            <span>タイトル</span>
                        </label>
                        <input type="text" id="editEventTitle"
                               class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>👥</span>
                            <span>対象者（複数選択可）</span>
                        </label>
                        <div id="editEmployeeCheckboxes" class="border-2 border-purple-200 rounded-xl p-3 max-h-32 overflow-y-auto bg-purple-50/50">
                        </div>
                        <div id="editSelectedEmployees" class="hidden mt-2 p-2 bg-purple-100 rounded-xl">
                            <div class="text-sm text-purple-700 font-bold">
                                ✨ 選択中: <span id="editSelectedEmployeesList"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📝</span>
                            <span>種類</span>
                        </label>
                        <select id="editEventType"
                                class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 bg-white/80 font-bold">
                            <option value="site">🏗️ 現場</option>
                            <option value="meeting">💬 打合せ</option>
                            <option value="leave">🌴 休暇</option>
                            <option value="training">📚 研修</option>
                            <option value="other">✨ その他</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕐</span>
                                <span>開始時間</span>
                            </label>
                            <input type="datetime-local" id="editEventStartTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                                <span>🕑</span>
                                <span>終了時間</span>
                            </label>
                            <input type="datetime-local" id="editEventEndTime"
                                   class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-purple-700 mb-2 flex items-center space-x-1">
                            <span>📋</span>
                            <span>詳細</span>
                        </label>
                        <textarea id="editEventDescription"
                                  class="w-full border-2 border-purple-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-all duration-300"
                                  rows="3"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-between mt-6 pt-4 border-t border-purple-200">
                    <button onclick="deleteSchedule()"
                            class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-xl hover:from-red-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold flex items-center space-x-2">
                        <span>🗑️</span>
                        <span>削除</span>
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="closeModal()"
                                class="px-4 py-2 text-gray-600 hover:text-gray-800 bg-gray-200 hover:bg-gray-300 rounded-xl transition-all duration-300 font-bold">
                            キャンセル
                        </button>
                        <button onclick="updateSchedule()"
                                class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-lg font-bold flex items-center space-x-2">
                            <span>💾</span>
                            <span>更新</span>
                            <span>✨</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // データ定義
        const departments = {
            '管理部': [
                { id: 1, name: '大仁田　真', password: '1', emoji: '👨‍💼', color: '#ff6b6b' },
                { id: 2, name: '高橋　伸輔', password: '3', emoji: '🧑‍💻', color: '#4ecdc4' },
                { id: 3, name: '佐々木　翔太', password: '4', emoji: '👨‍🔬', color: '#45b7d1' },
                { id: 4, name: '町田　総士', password: '5', emoji: '👨‍🎯', color: '#f9ca24' }
            ],
            '工事部': [
                { id: 5, name: '大仁田　実', password: '2', emoji: '👷‍♂️', color: '#f0932b' },
                { id: 6, name: '長谷　章一', password: '6', emoji: '🔧', color: '#eb4d4b' },
                { id: 7, name: '篠田　将吏', password: '7', emoji: '⚡', color: '#6c5ce7' },
                { id: 8, name: '荒木　晃太', password: '8', emoji: '🛠️', color: '#fd79a8' },
                { id: 9, name: '仲田　淳次', password: '9', emoji: '🏗️', color: '#00b894' },
                { id: 10, name: '白谷　富敬', password: '10', emoji: '⚙️', color: '#e17055' },
                { id: 11, name: '木村　善幸', password: '11', emoji: '🔨', color: '#81ecec' },
                { id: 12, name: '小林　常利', password: '12', emoji: '🚧', color: '#74b9ff' },
                { id: 13, name: '氏森　ルイス', password: '13', emoji: '🌟', color: '#55a3ff' }
            ]
        };

        // 全社員リスト
        const allEmployees = [];
        Object.entries(departments).forEach(([dept, employees]) => {
            employees.forEach(emp => {
                allEmployees.push({
                    ...emp,
                    department: dept
                });
            });
        });

        // グローバル状態
        let currentUser = null;
        let selectedDepartment = '';
        let selectedEmployee = '';
        let viewMode = 'calendar';
        let currentDate = new Date();
        let selectedUserFilter = 'all';
        let editingEventId = null;

        // スケジュールデータ
        let schedules = [
            {
                id: 1,
                title: '🎯 管理部会議',
                description: '月次売上報告 📊',
                startTime: '2025-06-11T09:00',
                endTime: '2025-06-11T10:00',
                employeeIds: [1, 2, 3, 4],
                createdBy: 1,
                createdAt: '2025-06-10T08:00:00',
                lastEditedBy: 1,
                lastEditedAt: '2025-06-10T08:00:00',
                type: 'meeting',
                isPublic: true
            },
            {
                id: 2,
                title: '🏗️ 現場視察',
                description: 'A工事現場の進捗確認 ✨',
                startTime: '2025-06-11T14:00',
                endTime: '2025-06-11T17:00',
                employeeIds: [5, 6],
                createdBy: 5,
                createdAt: '2025-06-10T10:00:00',
                lastEditedBy: 5,
                lastEditedAt: '2025-06-10T10:00:00',
                type: 'site',
                isPublic: true
            },
            {
                id: 3,
                title: '📚 安全講習',
                description: '新入社員向け安全教育 🛡️',
                startTime: '2025-06-12T10:00',
                endTime: '2025-06-12T12:00',
                employeeIds: [7, 8, 9],
                createdBy: 6,
                createdAt: '2025-06-09T15:00:00',
                lastEditedBy: 6,
                lastEditedAt: '2025-06-09T15:00:00',
                type: 'training',
                isPublic: true
            }
        ];

        // プロジェクト（物件）データ
        let projects = [];
        let projectFiles = {};
        let currentProjectId = null;

        // ユーティリティ関数
        function getEmployeeName(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.name : '不明';
        }

        function getEmployeeEmoji(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.emoji : '👤';
        }

        function getEmployeeColor(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.color : '#6b7280';
        }

        function getEmployeeDepartment(employeeId) {
            const employee = allEmployees.find(emp => emp.id === employeeId);
            return employee ? employee.department : '不明';
        }

        // ログイン機能
        function selectDepartment(dept) {
            selectedDepartment = dept;
            selectedEmployee = '';
            
            // 部署ボタンのスタイル更新
            document.querySelectorAll('[id^="dept-"]').forEach(btn => {
                btn.className = 'w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105';
            });
            document.getElementById(`dept-${dept}`).className = 'w-full p-3 rounded-xl border-2 border-purple-400 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 shadow-lg transition-all duration-300 transform hover:scale-105';
            
            // 社員選択セクションを表示
            const employeeSection = document.getElementById('employeeSection');
            const employeeList = document.getElementById('employeeList');
            
            employeeSection.className = 'animate-fadeIn';
            employeeList.innerHTML = '';
            
            departments[dept].forEach(emp => {
                const button = document.createElement('button');
                button.onclick = () => selectEmployee(emp.id);
                button.id = `emp-${emp.id}`;
                button.className = 'p-2 rounded-lg border border-gray-300 hover:border-pink-300 hover:bg-pink-50 bg-white transition-all duration-300 transform hover:scale-105';
                button.innerHTML = `
                    <div class="flex flex-col items-center space-y-1">
                        <span class="text-lg">${emp.emoji}</span>
                        <span class="text-xs font-bold">${emp.name}</span>
                    </div>
                `;
                employeeList.appendChild(button);
            });
            
            updateLoginButton();
        }

        function selectEmployee(empId) {
            selectedEmployee = empId;
            
            // 社員ボタンのスタイル更新
            document.querySelectorAll('[id^="emp-"]').forEach(btn => {
                btn.className = 'p-2 rounded-lg border border-gray-300 hover:border-pink-300 hover:bg-pink-50 bg-white transition-all duration-300 transform hover:scale-105';
            });
            document.getElementById(`emp-${empId}`).className = 'p-2 rounded-lg border-2 border-pink-400 bg-gradient-to-r from-pink-100 to-purple-100 text-pink-700 shadow-md transition-all duration-300 transform hover:scale-105';
            
            // パスワード入力セクションを表示
            document.getElementById('passwordSection').className = 'animate-fadeIn';
            
            updateLoginButton();
        }

        function updateLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            const canLogin = selectedDepartment && selectedEmployee && document.getElementById('passwordInput').value;
            
            if (canLogin) {
                loginBtn.disabled = false;
                loginBtn.className = 'w-full mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 font-bold transform hover:scale-105 hover:shadow-lg flex items-center justify-center space-x-2';
            } else {
                loginBtn.disabled = true;
                loginBtn.className = 'w-full mt-4 bg-gradient-to-r from-gray-300 to-gray-400 text-white py-3 rounded-xl font-bold cursor-not-allowed transition-all duration-300 flex items-center justify-center space-x-2';
            }
        }

        function handleLogin() {
            const password = document.getElementById('passwordInput').value;
            const loginError = document.getElementById('loginError');
            
            if (!selectedDepartment) {
                showError('🏢 部署を選択してください');
                return;
            }
            if (!selectedEmployee) {
                showError('👤 社員を選択してください');
                return;
            }
            if (!password) {
                showError('🔑 パスワードを入力してください');
                return;
            }

            const employee = allEmployees.find(emp => emp.id === parseInt(selectedEmployee));
            if (employee && employee.password === password) {
                currentUser = employee;
                
                // ユーザー情報を表示
                document.getElementById('currentUserName').innerHTML = `
                    <span>${employee.emoji}</span>
                    <span>${employee.name}</span>
                `;
                document.getElementById('currentUserDept').textContent = employee.department;
                
                // ユーザーフィルターにオプション追加
                const userFilter = document.getElementById('userFilter');
                userFilter.innerHTML = '<option value="all">🌟 全員</option>';
                allEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.emoji} ${emp.name}`;
                    userFilter.appendChild(option);
                });
                
                // 画面切り替え
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                
                // カレンダー初期化
                updateCalendar();
                
                loginError.classList.add('hidden');
            } else {
                showError('❌ パスワードが正しくありません');
            }
        }

        function showError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }

        function handleLogout() {
            currentUser = null;
            selectedDepartment = '';
            selectedEmployee = '';
            
            // フォームリセット
            document.getElementById('passwordInput').value = '';
            document.getElementById('employeeSection').classList.add('hidden');
            document.getElementById('passwordSection').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            
            // ボタンスタイルリセット
            document.querySelectorAll('[id^="dept-"]').forEach(btn => {
                btn.className = 'w-full p-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all duration-300 transform hover:scale-105';
            });
            
            // 画面切り替え
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            updateLoginButton();
        }

        // 表示モード切り替え
        function setViewMode(mode) {
            viewMode = mode;
            
            if (mode === 'calendar') {
                document.getElementById('calendarModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold transition-all duration-300 transform hover:scale-105';
                document.getElementById('cybozuModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-purple-100 hover:to-pink-100 font-bold transition-all duration-300 transform hover:scale-105';
                
                document.getElementById('calendarControls').classList.remove('hidden');
                document.getElementById('cybozuControls').classList.add('hidden');
                document.getElementById('calendarView').classList.remove('hidden');
                document.getElementById('cybozuView').classList.add('hidden');
                
                updateCalendar();
            } else {
                document.getElementById('cybozuModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold transition-all duration-300 transform hover:scale-105';
                document.getElementById('calendarModeBtn').className = 'mobile-button flex-1 md:flex-none px-3 md:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 hover:from-purple-100 hover:to-pink-100 font-bold transition-all duration-300 transform hover:scale-105';
                
                document.getElementById('calendarControls').classList.add('hidden');
                document.getElementById('cybozuControls').classList.remove('hidden');
                document.getElementById('calendarView').classList.add('hidden');
                document.getElementById('cybozuView').classList.remove('hidden');
                
                updateCybozuView();
            }
        }

        // カレンダー更新
        function updateCalendar() {
            // 月表示更新
            document.getElementById('currentMonth').textContent = `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月`;
            
            // カレンダーグリッド生成
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date().toISOString().split('T')[0];

            for (let i = 0; i < 42; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                
                const daySchedules = getSchedulesForDate(day);
                const isCurrentMonth = day.getMonth() === month;
                const isToday = day.toISOString().split('T')[0] === today;
                
                const dayCell = document.createElement('div');
                dayCell.className = `calendar-cell border-r border-b border-purple-100 min-h-16 md:min-h-24 p-1 md:p-2 transition-all duration-300 hover:bg-purple-50 cursor-pointer ${
                    !isCurrentMonth ? 'bg-gray-50/50' : isToday ? 'bg-gradient-to-br from-yellow-100 to-orange-100' : ''
                }`;
                dayCell.onclick = () => addScheduleForDate(day);
                
                const dayNumber = document.createElement('div');
                dayNumber.className = `text-xs md:text-sm font-bold mb-1 flex items-center justify-center ${
                    isToday ? 'bg-gradient-to-r from-orange-400 to-pink-400 text-white rounded-full w-5 h-5 md:w-6 md:h-6 text-xs' :
                    i % 7 === 0 ? 'text-red-500' : 
                    i % 7 === 6 ? 'text-blue-500' : 
                    'text-purple-700'
                }`;
                dayNumber.innerHTML = `${isToday ? '<span class="text-xs">🎯</span>' : ''}${day.getDate()}`;
                
                const scheduleContainer = document.createElement('div');
                scheduleContainer.className = 'space-y-1';
                
                // モバイルでは1件、デスクトップでは2件表示
                const maxSchedules = window.innerWidth <= 768 ? 1 : 2;
                
                daySchedules.slice(0, maxSchedules).forEach(schedule => {
                    const scheduleDiv = document.createElement('div');
                    scheduleDiv.className = 'schedule-item text-xs p-1 rounded cursor-pointer hover:opacity-80 transition-all duration-300 transform hover:scale-105 shadow-sm';
                    scheduleDiv.style.backgroundColor = `${getEmployeeColor(schedule.employeeIds[0])}30`;
                    scheduleDiv.style.borderLeft = `2px md:3px solid ${getEmployeeColor(schedule.employeeIds[0])}`;
                    scheduleDiv.onclick = (e) => {
                        e.stopPropagation();
                        editSchedule(schedule.id);
                    };
                    
                    scheduleDiv.innerHTML = `
                        <div class="font-bold truncate text-xs">${schedule.title}</div>
                        <div class="text-gray-700 flex items-center space-x-1 text-xs">
                            <span class="text-xs">${getEmployeeEmoji(schedule.employeeIds[0])}</span>
                            <span class="truncate">
                                ${schedule.employeeIds.length > 1 ? `${getEmployeeName(schedule.employeeIds[0])} 他${schedule.employeeIds.length - 1}名` : getEmployeeName(schedule.employeeIds[0])}
                            </span>
                        </div>
                    `;
                    scheduleContainer.appendChild(scheduleDiv);
                });
                
                if (daySchedules.length > maxSchedules) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'text-xs text-purple-600 font-bold';
                    moreDiv.textContent = `✨ 他${daySchedules.length - maxSchedules}件`;
                    scheduleContainer.appendChild(moreDiv);
                }
                
                dayCell.appendChild(dayNumber);
                dayCell.appendChild(scheduleContainer);
                calendarGrid.appendChild(dayCell);
            }
        }

        // サイボウズ風表示更新
        function updateCybozuView() {
            const weekDays = generateWeekDays();
            document.getElementById('currentWeek').textContent = 
                `${weekDays[0].getFullYear()}年${weekDays[0].getMonth() + 1}月${weekDays[0].getDate()}日〜${weekDays[6].getMonth() + 1}月${weekDays[6].getDate()}日`;
            
            const cybozuGrid = document.getElementById('cybozuGrid');
            cybozuGrid.innerHTML = '';
            
            // ヘッダー行
            const headerRow = document.createElement('div');
            headerRow.className = 'grid border-b border-purple-200 bg-gradient-to-r from-purple-100 to-pink-100';
            // モバイルとデスクトップで異なるグリッド設定
            if (window.innerWidth <= 768) {
                headerRow.style.gridTemplateColumns = '100px repeat(7, 45px)';
            } else {
                headerRow.style.gridTemplateColumns = 'minmax(120px, 200px) repeat(7, 1fr)';
            }
            
            const employeeHeader = document.createElement('div');
            employeeHeader.className = 'cybozu-employee-cell p-2 md:p-3 font-bold text-purple-700 border-r border-purple-200 flex items-center justify-center text-xs md:text-sm';
            employeeHeader.innerHTML = '<span class="md:hidden">👥</span><span class="hidden md:inline">👥 社員名</span>';
            headerRow.appendChild(employeeHeader);
            
            const today = new Date().toISOString().split('T')[0];
            
            weekDays.forEach((day, index) => {
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][day.getDay()];
                const dayEmoji = ['🌅', '🌙', '🔥', '💧', '🌳', '⭐', '🌈'][day.getDay()];
                const isToday = day.toISOString().split('T')[0] === today;
                
                const dayHeader = document.createElement('div');
                dayHeader.className = `cybozu-day-header p-2 md:p-3 text-center font-bold border-r border-purple-200 text-xs md:text-sm ${
                    isToday ? 'bg-gradient-to-br from-yellow-200 to-orange-200 text-orange-700' :
                    day.getDay() === 0 ? 'text-red-500' : 
                    day.getDay() === 6 ? 'text-blue-500' : 
                    'text-purple-700'
                }`;
                
                dayHeader.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="flex items-center justify-center space-x-1">
                            <span class="text-xs">${dayEmoji}</span>
                            <span class="text-xs">${day.getMonth() + 1}/${day.getDate()}</span>
                        </div>
                        <div class="text-xs">(<span class="md:hidden">${dayOfWeek.charAt(0)}</span><span class="hidden md:inline">${dayOfWeek}</span>)</div>
                        ${isToday ? '<div class="text-xs">✨</div>' : ''}
                    </div>
                `;
                headerRow.appendChild(dayHeader);
            });
            
            cybozuGrid.appendChild(headerRow);
            
            // 部署別社員行
            Object.entries(departments).forEach(([dept, employees]) => {
                // 部署ヘッダー
                const deptHeaderRow = document.createElement('div');
                deptHeaderRow.className = 'grid bg-gradient-to-r from-purple-100 to-pink-100 border-b border-purple-200';
                // モバイルとデスクトップで異なるグリッド設定
                if (window.innerWidth <= 768) {
                    deptHeaderRow.style.gridTemplateColumns = '80px repeat(7, 1fr)';
                } else {
                    deptHeaderRow.style.gridTemplateColumns = 'minmax(120px, 200px) repeat(7, 1fr)';
                }
                
                const deptHeader = document.createElement('div');
                deptHeader.className = 'p-1 md:p-2 font-bold text-purple-700 border-r border-purple-200 flex items-center space-x-2 text-xs md:text-sm';
                deptHeader.style.gridColumn = '1 / -1';
                deptHeader.innerHTML = `
                    <span>${dept === '管理部' ? '🏢' : '🏗️'}</span>
                    <span>${dept}</span>
                    <span class="bg-white/60 px-1 md:px-2 py-1 rounded-full text-xs">(${employees.length}名)</span>
                `;
                deptHeaderRow.appendChild(deptHeader);
                cybozuGrid.appendChild(deptHeaderRow);
                
                // 各社員の行
                employees.forEach(emp => {
                    const empData = allEmployees.find(e => e.id === emp.id);
                    const empRow = document.createElement('div');
                    empRow.className = 'grid border-b border-purple-100 hover:bg-purple-50/50 transition-all duration-300';
                    // モバイルとデスクトップで異なるグリッド設定
                    if (window.innerWidth <= 768) {
                        empRow.style.gridTemplateColumns = '80px repeat(7, 1fr)';
                    } else {
                        empRow.style.gridTemplateColumns = 'minmax(120px, 200px) repeat(7, 1fr)';
                    }
                    
                    // 社員名
                    const empNameCell = document.createElement('div');
                    empNameCell.className = 'cybozu-employee-cell p-2 md:p-3 border-r border-purple-200 bg-white/60';
                    empNameCell.innerHTML = `
                        <div class="flex flex-col md:flex-row items-center space-y-1 md:space-y-0 md:space-x-2">
                            <div class="w-2 h-2 md:w-3 md:h-3 rounded-full shadow-sm" style="background-color: ${empData.color}"></div>
                            <span class="text-sm md:text-lg">${emp.emoji}</span>
                            <span class="text-xs md:text-sm font-bold text-purple-700 truncate text-center md:text-left">${emp.name}</span>
                        </div>
                    `;
                    empRow.appendChild(empNameCell);
                    
                    // 各曜日の予定
                    weekDays.forEach(day => {
                        const daySchedules = getSchedulesForEmployeeAndDate(emp.id, day);
                        const isToday = day.toISOString().split('T')[0] === today;
                        
                        const dayCell = document.createElement('div');
                        dayCell.className = `cybozu-day-cell p-1 md:p-2 border-r border-purple-200 min-h-12 md:min-h-16 ${
                            isToday ? 'bg-gradient-to-br from-yellow-50 to-orange-50' : ''
                        }`;
                        
                        const scheduleContainer = document.createElement('div');
                        scheduleContainer.className = 'space-y-1';
                        
                        daySchedules.forEach(schedule => {
                            const scheduleDiv = document.createElement('div');
                            scheduleDiv.className = 'cybozu-schedule-item text-xs p-1 rounded cursor-pointer hover:opacity-80 transition-all duration-300 transform hover:scale-105 shadow-sm';
                            scheduleDiv.style.backgroundColor = `${getEmployeeColor(schedule.employeeIds[0])}30`;
                            scheduleDiv.style.borderLeft = `1px md:2px solid ${getEmployeeColor(schedule.employeeIds[0])}`;
                            scheduleDiv.onclick = (e) => {
                                e.stopPropagation();
                                editSchedule(schedule.id);
                            };
                            
                            const startTime = new Date(schedule.startTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                            
                            scheduleDiv.innerHTML = `
                                <div class="font-bold truncate text-xs">${schedule.title}</div>
                                <div class="text-gray-600 flex items-center space-x-1 text-xs">
                                    <span class="text-xs">🕐</span>
                                    <span class="text-xs">${startTime}</span>
                                    ${schedule.employeeIds.length > 1 ? 
                                        `<span class="bg-purple-200 text-purple-700 px-1 rounded-full text-xs font-bold">+${schedule.employeeIds.length - 1}</span>` : ''
                                    }
                                </div>
                            `;
                            scheduleContainer.appendChild(scheduleDiv);
                        });
                        
                        // 予定追加ボタンを常に表示（予定がある日でも追加可能）
                        const addDiv = document.createElement('div');
                        addDiv.className = 'cybozu-add-button text-gray-400 text-xs p-1 cursor-pointer hover:bg-purple-100 rounded border border-dashed border-purple-200 transition-all duration-300 transform hover:scale-105 text-center mt-1';
                        addDiv.onclick = (e) => {
                            e.stopPropagation();
                            addScheduleForEmployeeAndDate(emp.id, day);
                        };
                        addDiv.innerHTML = '<div class="text-xs">✨</div><div class="text-xs">予定追加</div>';
                        scheduleContainer.appendChild(addDiv);
                        
                        dayCell.appendChild(scheduleContainer);
                        empRow.appendChild(dayCell);
                    });
                    
                    cybozuGrid.appendChild(empRow);
                });
            });
        }

        // 週間日付生成
        function generateWeekDays() {
            const startOfWeek = new Date(currentDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
            startOfWeek.setDate(diff);

            const days = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                days.push(day);
            }
            return days;
        }

        // 指定日のスケジュール取得
        function getSchedulesForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return schedules.filter(schedule => {
                const scheduleDate = schedule.startTime.split('T')[0];
                const matchesDate = scheduleDate === dateStr;
                const matchesUser = selectedUserFilter === 'all' || schedule.employeeIds.includes(parseInt(selectedUserFilter));
                return matchesDate && matchesUser && schedule.isPublic;
            });
        }

        // 指定社員の指定日のスケジュール取得
        function getSchedulesForEmployeeAndDate(employeeId, date) {
            const dateStr = date.toISOString().split('T')[0];
            return schedules.filter(schedule => {
                const scheduleDate = schedule.startTime.split('T')[0];
                return schedule.employeeIds.includes(employeeId) && scheduleDate === dateStr && schedule.isPublic;
            });
        }

        // ナビゲーション
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        }

        function previousWeek() {
            currentDate.setDate(currentDate.getDate() - 7);
            updateCybozuView();
        }

        function nextWeek() {
            currentDate.setDate(currentDate.getDate() + 7);
            updateCybozuView();
        }

        function filterByUser() {
            selectedUserFilter = document.getElementById('userFilter').value;
            if (viewMode === 'calendar') {
                updateCalendar();
            } else {
                updateCybozuView();
            }
        }

        // モーダル機能
        function showAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            initNewEventForm();
            generateEmployeeCheckboxes('employeeCheckboxes', 'selectedEmployees', 'selectedEmployeesList');
        }

        function initNewEventForm() {
            const now = new Date();
            const startTime = new Date(now.setMinutes(0, 0, 0));
            const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
            
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventStartTime').value = startTime.toISOString().slice(0, 16);
            document.getElementById('eventEndTime').value = endTime.toISOString().slice(0, 16);
            document.getElementById('eventType').value = 'meeting';
        }

        function addScheduleForDate(date) {
            const scheduleDate = date.toISOString().slice(0, 10);
            document.getElementById('eventStartTime').value = `${scheduleDate}T09:00`;
            document.getElementById('eventEndTime').value = `${scheduleDate}T10:00`;
            
            showAddModal();
        }

        function addScheduleForEmployeeAndDate(employeeId, date) {
            const scheduleDate = date.toISOString().slice(0, 10);
            document.getElementById('eventStartTime').value = `${scheduleDate}T09:00`;
            document.getElementById('eventEndTime').value = `${scheduleDate}T10:00`;
            
            // 特定の社員を選択状態にする
            setTimeout(() => {
                const checkbox = document.querySelector(`input[data-employee-id="${employeeId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    updateSelectedEmployees('selectedEmployees', 'selectedEmployeesList');
                }
            }, 100);
            
            showAddModal();
        }

        function editSchedule(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            
            editingEventId = scheduleId;
            
            // フォームに値を設定
            document.getElementById('editEventTitle').value = schedule.title;
            document.getElementById('editEventDescription').value = schedule.description;
            document.getElementById('editEventStartTime').value = schedule.startTime;
            document.getElementById('editEventEndTime').value = schedule.endTime;
            document.getElementById('editEventType').value = schedule.type;
            
            // 履歴情報表示
            const historyDiv = document.getElementById('eventHistory');
            historyDiv.innerHTML = `
                <div class="flex justify-between items-center text-sm">
                    <span class="flex items-center space-x-2">
                        <span>📝</span>
                        <span class="font-bold">登録者:</span>
                        <span>${getEmployeeEmoji(schedule.createdBy)} ${getEmployeeName(schedule.createdBy)}</span>
                    </span>
                    <span class="text-purple-600 font-bold">${new Date(schedule.createdAt).toLocaleString('ja-JP')}</span>
                </div>
                ${schedule.lastEditedBy !== schedule.createdBy ? `
                    <div class="flex justify-between items-center mt-2 text-sm text-purple-600">
                        <span class="flex items-center space-x-2">
                            <span>✏️</span>
                            <span class="font-bold">最終編集:</span>
                            <span>${getEmployeeEmoji(schedule.lastEditedBy)} ${getEmployeeName(schedule.lastEditedBy)}</span>
                        </span>
                        <span class="font-bold">${new Date(schedule.lastEditedAt).toLocaleString('ja-JP')}</span>
                    </div>
                ` : ''}
            `;
            
            generateEmployeeCheckboxes('editEmployeeCheckboxes', 'editSelectedEmployees', 'editSelectedEmployeesList');
            
            // 選択状態を設定
            setTimeout(() => {
                schedule.employeeIds.forEach(empId => {
                    const checkbox = document.querySelector(`#editEmployeeCheckboxes input[data-employee-id="${empId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                updateSelectedEmployees('editSelectedEmployees', 'editSelectedEmployeesList');
            }, 100);
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function generateEmployeeCheckboxes(containerId, selectedContainerId, selectedListId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            Object.entries(departments).forEach(([dept, employees]) => {
                const deptDiv = document.createElement('div');
                deptDiv.className = 'mb-3 last:mb-0';
                
                const deptHeader = document.createElement('div');
                deptHeader.className = 'font-bold text-purple-700 mb-2 flex items-center space-x-2';
                deptHeader.innerHTML = `
                    <span>${dept === '管理部' ? '🏢' : '🏗️'}</span>
                    <span>${dept}</span>
                `;
                deptDiv.appendChild(deptHeader);
                
                const empGrid = document.createElement('div');
                empGrid.className = 'grid grid-cols-2 gap-2';
                
                employees.forEach(emp => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 cursor-pointer bg-white/60 p-2 rounded-lg hover:bg-white/80 transition-all duration-300';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.employeeId = emp.id;
                    checkbox.className = 'text-purple-600 focus:ring-purple-500 w-4 h-4 rounded';
                    checkbox.onchange = () => updateSelectedEmployees(selectedContainerId, selectedListId);
                    
                    label.innerHTML = `
                        <span class="text-lg">${emp.emoji}</span>
                        <span class="text-sm font-bold text-purple-700">${emp.name}</span>
                    `;
                    label.insertBefore(checkbox, label.firstChild);
                    
                    empGrid.appendChild(label);
                });
                
                deptDiv.appendChild(empGrid);
                container.appendChild(deptDiv);
            });
        }

        function updateSelectedEmployees(selectedContainerId, selectedListId) {
            const selectedContainer = document.getElementById(selectedContainerId);
            const selectedList = document.getElementById(selectedListId);
            
            const checkboxes = selectedContainer.parentNode.querySelectorAll('input[type="checkbox"]:checked');
            const selectedEmployees = Array.from(checkboxes).map(cb => {
                const empId = parseInt(cb.dataset.employeeId);
                return `${getEmployeeEmoji(empId)} ${getEmployeeName(empId)}`;
            });
            
            if (selectedEmployees.length > 0) {
                selectedContainer.classList.remove('hidden');
                selectedList.textContent = selectedEmployees.join(', ');
            } else {
                selectedContainer.classList.add('hidden');
            }
        }

        function addSchedule() {
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value;
            const startTime = document.getElementById('eventStartTime').value;
            const endTime = document.getElementById('eventEndTime').value;
            const type = document.getElementById('eventType').value;
            
            const selectedEmployeeIds = Array.from(document.querySelectorAll('#employeeCheckboxes input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.dataset.employeeId));
            
            if (!title || selectedEmployeeIds.length === 0) return;
            
            const newSchedule = {
                id: Date.now(),
                title,
                description,
                startTime,
                endTime,
                employeeIds: selectedEmployeeIds,
                type,
                isPublic: true,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                lastEditedBy: currentUser.id,
                lastEditedAt: new Date().toISOString()
            };
            
            schedules.push(newSchedule);
            closeModal();
            
            if (viewMode === 'calendar') {
                updateCalendar();
            } else {
                updateCybozuView();
            }
        }

        function updateSchedule() {
            const title = document.getElementById('editEventTitle').value.trim();
            const description = document.getElementById('editEventDescription').value;
            const startTime = document.getElementById('editEventStartTime').value;
            const endTime = document.getElementById('editEventEndTime').value;
            const type = document.getElementById('editEventType').value;
            
            const selectedEmployeeIds = Array.from(document.querySelectorAll('#editEmployeeCheckboxes input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.dataset.employeeId));
            
            if (!title || selectedEmployeeIds.length === 0) return;
            
            const scheduleIndex = schedules.findIndex(s => s.id === editingEventId);
            if (scheduleIndex !== -1) {
                schedules[scheduleIndex] = {
                    ...schedules[scheduleIndex],
                    title,
                    description,
                    startTime,
                    endTime,
                    employeeIds: selectedEmployeeIds,
                    type,
                    lastEditedBy: currentUser.id,
                    lastEditedAt: new Date().toISOString()
                };
            }
            
            closeModal();
            
            if (viewMode === 'calendar') {
                updateCalendar();
            } else {
                updateCybozuView();
            }
        }

        function deleteSchedule() {
            if (editingEventId) {
                schedules = schedules.filter(s => s.id !== editingEventId);
                closeModal();
                
                if (viewMode === 'calendar') {
                    updateCalendar();
                } else {
                    updateCybozuView();
                }
            }
        }

        function closeModal() {
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('editModal').classList.add('hidden');
            editingEventId = null;
        }

        // パスワード入力時の処理
        document.getElementById('passwordInput').addEventListener('input', updateLoginButton);

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setViewMode('calendar');
            cleanupExpiredProjects();
            setupFileUploadHandlers();
        });

        // 画面リサイズ時の処理
        window.addEventListener('resize', function() {
            if (viewMode === 'cybozu') {
                updateCybozuView();
            }
        });

        // ファイル共有機能
        function showFileSharing() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('fileSharingScreen').classList.remove('hidden');
            updateProjectsList();
        }

        function backToLogin() {
            document.getElementById('fileSharingScreen').classList.add('hidden');
            document.getElementById('projectDetailScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function backToFileSharing() {
            document.getElementById('projectDetailScreen').classList.add('hidden');
            document.getElementById('fileSharingScreen').classList.remove('hidden');
            updateProjectsList();
        }

        function showCreateProjectModal() {
            document.getElementById('createProjectModal').classList.remove('hidden');
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
        }

        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('hidden');
        }

        function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            
            if (!name) {
                alert('物件名を入力してください');
                return;
            }
            
            const projectId = Date.now();
            const project = {
                id: projectId,
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 8 * 30 * 24 * 60 * 60 * 1000).toISOString() // 8カ月後
            };
            
            projects.push(project);
            projectFiles[projectId] = {
                siteMap: [],
                schedule: [],
                drawings: [],
                training: []
            };
            
            closeCreateProjectModal();
            updateProjectsList();
        }

        function updateProjectsList() {
            const projectsList = document.getElementById('projectsList');
            const noProjects = document.getElementById('noProjects');
            
            if (projects.length === 0) {
                projectsList.innerHTML = '';
                noProjects.classList.remove('hidden');
                return;
            }
            
            noProjects.classList.add('hidden');
            projectsList.innerHTML = '';
            
            projects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'bg-white/80 backdrop-blur-sm rounded-xl shadow-lg border border-green-100 p-4 hover:shadow-xl transition-all duration-300 transform hover:scale-105 cursor-pointer';
                projectCard.onclick = () => openProject(project.id);
                
                const expiresDate = new Date(project.expiresAt);
                const daysLeft = Math.ceil((expiresDate - new Date()) / (1000 * 60 * 60 * 24));
                
                projectCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-green-700 text-lg flex items-center space-x-2">
                            <span>🏗️</span>
                            <span>${project.name}</span>
                        </h3>
                        <button onclick="deleteProject(${project.id}); event.stopPropagation();" 
                                class="text-red-500 hover:text-red-700 transition-colors"
                                title="削除">
                            <span>🗑️</span>
                        </button>
                    </div>
                    ${project.description ? `<p class="text-gray-600 text-sm mb-3">${project.description}</p>` : ''}
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>作成日: ${new Date(project.createdAt).toLocaleDateString('ja-JP')}</span>
                        <span class="${daysLeft < 30 ? 'text-red-500 font-bold' : 'text-gray-500'}">
                            残り${daysLeft}日
                        </span>
                    </div>
                `;
                
                projectsList.appendChild(projectCard);
            });
        }

        function openProject(projectId) {
            currentProjectId = projectId;
            const project = projects.find(p => p.id === projectId);
            
            document.getElementById('projectDetailTitle').textContent = project.name;
            document.getElementById('fileSharingScreen').classList.add('hidden');
            document.getElementById('projectDetailScreen').classList.remove('hidden');
            
            updateFilesList();
        }

        function deleteProject(projectId) {
            if (confirm('この物件を削除してもよろしいですか？\n関連するファイルもすべて削除されます。')) {
                projects = projects.filter(p => p.id !== projectId);
                delete projectFiles[projectId];
                updateProjectsList();
            }
        }

        function cleanupExpiredProjects() {
            const now = new Date();
            const expiredProjects = projects.filter(project => new Date(project.expiresAt) <= now);
            
            if (expiredProjects.length > 0) {
                expiredProjects.forEach(project => {
                    delete projectFiles[project.id];
                });
                projects = projects.filter(project => new Date(project.expiresAt) > now);
            }
        }

        function setupFileUploadHandlers() {
            const fileTypes = ['siteMap', 'schedule', 'drawings', 'training'];
            
            fileTypes.forEach(type => {
                const input = document.getElementById(type);
                if (input) {
                    input.addEventListener('change', (event) => handleFileUpload(event, type));
                }
            });
        }

        function handleFileUpload(event, category) {
            const files = Array.from(event.target.files);
            const projectFiles_current = projectFiles[currentProjectId];
            
            if (!projectFiles_current) return;
            
            files.forEach(file => {
                const fileData = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadedAt: new Date().toISOString(),
                    data: null // ブラウザ制限のため実際のファイルデータは保存できません
                };
                
                // ファイルを読み込んでData URLとして保存
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileData.data = e.target.result;
                    projectFiles_current[category].push(fileData);
                    updateFilesList();
                };
                reader.readAsDataURL(file);
            });
            
            // ファイル入力をリセット
            event.target.value = '';
        }

        function updateFilesList() {
            const categories = {
                siteMap: 'siteMapFiles',
                schedule: 'scheduleFiles', 
                drawings: 'drawingsFiles',
                training: 'trainingFiles'
            };
            
            const projectFiles_current = projectFiles[currentProjectId];
            if (!projectFiles_current) return;
            
            Object.entries(categories).forEach(([category, containerId]) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                projectFiles_current[category].forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm';
                    
                    fileDiv.innerHTML = `
                        <div class="flex items-center space-x-2 flex-1 min-w-0">
                            <span>📄</span>
                            <span class="truncate font-medium">${file.name}</span>
                            <span class="text-xs text-gray-500">${formatFileSize(file.size)}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button onclick="downloadFile('${file.id}', '${category}')" 
                                    class="text-blue-600 hover:text-blue-800 transition-colors p-1"
                                    title="ダウンロード">
                                📥
                            </button>
                            <button onclick="deleteFile('${file.id}', '${category}')" 
                                    class="text-red-600 hover:text-red-800 transition-colors p-1"
                                    title="削除">
                                🗑️
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(fileDiv);
                });
                
                if (projectFiles_current[category].length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'text-center py-4 text-gray-500 text-sm';
                    emptyDiv.innerHTML = `
                        <div class="text-2xl mb-1">📂</div>
                        <p>ファイルがありません</p>
                    `;
                    container.appendChild(emptyDiv);
                }
            });
        }

        function downloadFile(fileId, category) {
            const projectFiles_current = projectFiles[currentProjectId];
            const file = projectFiles_current[category].find(f => f.id == fileId);
            
            if (file && file.data) {
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function deleteFile(fileId, category) {
            if (confirm('このファイルを削除してもよろしいですか？')) {
                const projectFiles_current = projectFiles[currentProjectId];
                projectFiles_current[category] = projectFiles_current[category].filter(f => f.id != fileId);
                updateFilesList();
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
